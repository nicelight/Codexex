import{a as u,r as h,g as C,c as A,e as k,f as L}from"../assets/chrome-CWUhAqIv.js";import{n as N,i as U,a as D}from"../assets/url-BvzPlvhJ.js";const I=['[aria-busy="true"]','[role="progressbar"]',".animate-spin",".loading-spinner",'svg[role="img"] animateTransform'],x={en:["stop","stop run","cancel","cancel run","cancel task"],ru:["остановить","прервать","отменить","отменить задачу"]},_=["button",'[role="button"]',"a[href]"],O="div.absolute.inset-0.flex.items-center.justify-center";class H{constructor(t){this.document=t.document,this.logger=u(t.logger,"scanner")}reset(){}scan(t){const e=V(this.document),i=B(this.document),n=M(this.document,e),r=R(this.document),o=[...i,...n,...r?[r.signal]:[]],c=[i.length>0?Math.max(1,i.length):0,n.length,(r==null?void 0:r.count)??0].reduce((S,v)=>Math.max(S,v),0),d=c>0;return this.logger.debug("scan result",JSON.stringify({active:d,count:c,spinnerSignals:i.length,stopSignals:n.length,counter:(r==null?void 0:r.count)??0})),{active:d,count:c,signals:o,ts:t}}}function V(s){var i,n,r;const t=(i=s.documentElement.lang)==null?void 0:i.trim().toLowerCase();if(t!=null&&t.startsWith("ru"))return"ru";const e=(r=(n=s.defaultView)==null?void 0:n.navigator.language)==null?void 0:r.toLowerCase();return e!=null&&e.startsWith("ru")?"ru":"en"}function B(s){const t=new Set,e=[],i=s.documentElement??s;return I.forEach(n=>{i.querySelectorAll(n).forEach(r=>{t.has(r)||(t.add(r),!(e.length>=5)&&e.push({detector:"D1_SPINNER",evidence:`${m(r)}#${e.length}`}))})}),e}function M(s,t){const e=[],i=s.documentElement??s;return Array.from(i.querySelectorAll(_.join(","))).forEach(r=>{if(!q(r,s)||$(r)||!z(r,t))return;const o=e.length,a=K(r);e.push({detector:"D2_STOP_BUTTON",evidence:`${m(r)}#${o}`,...a?{taskKey:a}:{}})}),e}function R(s){const t=s.documentElement??s,e=Array.from(t.querySelectorAll(O));let i=0,n;if(e.forEach((r,o)=>{const a=P(r);typeof a=="number"&&Number.isFinite(a)&&a>i&&(i=a,n=`${m(r)}#${o}`)}),!(i<=0||!n))return{count:i,signal:{detector:"D4_TASK_COUNTER",evidence:n}}}function P(s){var n;const t=(n=s.textContent)==null?void 0:n.trim();if(!t)return;const e=t.match(/\d+/);if(!e)return;const i=Number.parseInt(e[0]??"",10);return Number.isNaN(i)?void 0:i}function z(s,t){const e=[];if(s.textContent&&e.push(s.textContent),s instanceof HTMLElement){const i=s.getAttribute("title"),n=s.getAttribute("aria-label"),r=s.getAttribute("data-testid");i&&e.push(i),n&&e.push(n),r&&e.push(r)}return e.some(i=>F(i,t))}function F(s,t){const e=s.replace(/\s+/g," ").trim().toLowerCase();return e?x[t].some(n=>e.includes(n))?!0:e.includes("stop")||e.includes("cancel"):!1}function $(s){var e;if(s instanceof HTMLButtonElement&&s.disabled)return!0;const t=(e=s.getAttribute)==null?void 0:e.call(s,"aria-disabled");return typeof t=="string"&&t.toLowerCase()==="true"}function q(s,t){var i;let e=s;for(;e;){if(e instanceof HTMLElement){if(e.hidden)return!1;const n=e.getAttribute("aria-hidden");if(typeof n=="string"&&n.toLowerCase()==="true")return!1;const r=((i=e.ownerDocument)==null?void 0:i.defaultView)??t.defaultView;if(r){const o=r.getComputedStyle(e);if(o.display==="none"||o.visibility==="hidden")return!1;const a=Number.parseFloat(o.opacity||"1");if(Number.isFinite(a)&&a===0)return!1}}e=e.parentElement}return!0}function K(s){var i,n,r;let t=s;const e=new Set;for(;t&&!e.has(t);){e.add(t);const o=((i=t.getAttribute)==null?void 0:i.call(t,"data-task-id"))??((n=t.getAttribute)==null?void 0:n.call(t,"data-id"))??((r=t.getAttribute)==null?void 0:r.call(t,"data-reactid"));if(o)return o;t=t.parentElement}}function m(s){const t=s.tagName.toLowerCase(),e=s.id?`#${s.id}`:"",i=s instanceof HTMLElement?s.className.toString().split(/\s+/).filter(n=>n.length>0).slice(0,3).map(n=>`.${n}`).join(""):"";return`${t}${e}${i}`||t}function G(s){return new Promise(t=>s(t))}async function p(s,t){var i;const e=h();if(!((i=e.runtime)!=null&&i.id)){t.warn("runtime unavailable, skipping message (runtime-id-missing)");return}t.debug("post message",s),await G(n=>{try{e.runtime.sendMessage(s,()=>{const r=e.runtime.lastError;r&&t.warn("sendMessage error",r.message),n()})}catch(r){t.error("sendMessage threw",r),n()}})}function j(s){if(!s||typeof s!="object")return;const{type:t}=s;if(t==="PING"||t==="RESET"||t==="REQUEST_STATE")return{type:t};if(t==="AUDIO_CHIME"){const{volume:e}=s;return{type:"AUDIO_CHIME",volume:typeof e=="number"?e:void 0}}if(t==="AUDIO_PREVIEW"){const{volume:e}=s;return{type:"AUDIO_PREVIEW",volume:typeof e=="number"?e:void 0}}if(t==="AUDIO_SETTINGS_UPDATE"){const{sound:e,soundVolume:i}=s;return{type:"AUDIO_SETTINGS_UPDATE",...typeof e=="boolean"?{sound:e}:{},...typeof i=="number"?{soundVolume:i}:{}}}}function W(s,t){const e=h(),i=u(t,"background-listener"),n=(r,o)=>{const a=j(r);if(a){i.debug("received event",a);try{const c=s(a,o);c&&typeof c.then=="function"&&c.catch(d=>{i.error("handler rejected",d)})}catch(c){i.error("handler threw",c)}}};return e.runtime.onMessage.addListener(n),()=>{e.runtime.onMessage.removeListener(n)}}const Z="media/oh-oh-icq-sound.mp3",y=.2,b=.02,f=.35,Q=880;class Y{constructor(t){this.chrome=h(),this.pending=!1,this.unlocked=!1,this.initialized=!1,this.unlockListenersAttached=!1,this.volume=y,this.enabled=!0,this.window=t.window,this.logger=u(t.logger,"audio"),this.unlockEventHandler=()=>{this.detachUnlockListeners(),this.unlock()},this.attachUnlockListeners()}async ensureInitialized(){this.initialized||(this.initialized=!0,this.attachUnlockListeners())}async unlock(){this.detachUnlockListeners();const t=this.window.AudioContext??this.window.webkitAudioContext;if(t){if(this.unlocked){await this.resumeContextIfNeeded();return}try{this.audioContext=new t,this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=0,this.gainNode.connect(this.audioContext.destination),this.unlocked=!0,this.unlockListenersAttached=!1,await this.resumeContextIfNeeded(),this.pending&&(this.pending=!1,await this.ensureAudioBuffer(),await this.playChime())}catch(e){this.logger.warn("audio unlock failed",e),this.attachUnlockListeners()}}}applySettings(t){typeof t.sound=="boolean"&&(this.enabled=t.sound),typeof t.soundVolume=="number"&&(this.volume=g(t.soundVolume))}async handleChimeRequest(t){if(!this.enabled){this.pending=!1;return}if(!this.unlocked){this.pending=!0,this.attachUnlockListeners();return}await this.resumeContextIfNeeded(),await this.ensureAudioBuffer(),await this.playChime(t)}attachUnlockListeners(){this.unlocked||this.unlockListenersAttached||(this.unlockListenersAttached=!0,this.window.addEventListener("pointerdown",this.unlockEventHandler,{capture:!0}),this.window.addEventListener("keydown",this.unlockEventHandler,{capture:!0}))}detachUnlockListeners(){this.unlockListenersAttached&&(this.window.removeEventListener("pointerdown",this.unlockEventHandler,!0),this.window.removeEventListener("keydown",this.unlockEventHandler,!0),this.unlockListenersAttached=!1)}async resumeContextIfNeeded(){if(this.audioContext&&this.audioContext.state==="suspended")try{await this.audioContext.resume()}catch(t){this.logger.debug("audio resume failed",t)}}async ensureAudioBuffer(){var i;if(this.audioBuffer||!this.audioContext)return;const t=(i=this.chrome.runtime.getURL)==null?void 0:i.bind(this.chrome.runtime);if(!t){this.logger.debug("audio buffer load skipped: runtime.getURL unavailable");return}const e=t(Z);try{const n=await fetch(e);if(!n.ok)throw new Error(`fetch status ${n.status}`);const r=await n.arrayBuffer();this.audioBuffer=await this.decodeAudioData(r)}catch(n){this.logger.debug("audio buffer load failed",n)}}async decodeAudioData(t){if(this.audioContext&&typeof this.audioContext.decodeAudioData=="function")return this.audioContext.decodeAudioData(t)}async playChime(t){if(!this.audioContext||!this.gainNode){this.pending=!0;return}const e=g(typeof t=="number"?t:this.volume);if(!(e<=0)){if(this.audioBuffer){this.playBuffer(e);return}this.playOscillator(e)}}playBuffer(t){if(!this.audioContext||!this.gainNode||!this.audioBuffer){this.pending=!0;return}const e=this.audioContext,i=e.createBufferSource();i.buffer=this.audioBuffer,i.connect(this.gainNode),w(e,this.gainNode,t),i.start(e.currentTime),i.stop(e.currentTime+f+.1),i.addEventListener("ended",()=>{i.disconnect()})}playOscillator(t){if(!this.audioContext||!this.gainNode){this.pending=!0;return}const e=this.audioContext,i=e.createOscillator();i.type="triangle",i.frequency.value=Q,i.connect(this.gainNode),w(e,this.gainNode,t),i.start(e.currentTime),i.stop(e.currentTime+f+.1),i.addEventListener("ended",()=>{i.disconnect()})}}function w(s,t,e){const i=s.currentTime;t.gain.cancelScheduledValues(i);const n=g(e);t.gain.setValueAtTime(0,i),t.gain.linearRampToValueAtTime(n,i+b),t.gain.linearRampToValueAtTime(0,i+b+f)}function g(s){return Number.isFinite(s)?s<=0?0:s>=1?1:s:y}const J=500,E=15e3,X=1e3,T="codex.tasks.verbose";function tt(s){const t=N((s==null?void 0:s.pathname)??"/");return U(t)||D(t)}function et(s){return{active:!1,count:0,signals:[],ts:s}}class it{constructor(t){this.lastUpdateTs=0,this.lastScanAt=0,this.isDestroyed=!1,this.verbose=!1,this.window=t.window,C(this.window),this.verboseLogger=this.createVerbosityAwareLogger(),this.logger=u(this.verboseLogger,"runtime"),this.scanner=new H({document:this.window.document,logger:u(this.verboseLogger,"scanner")}),this.mutationObserver=new MutationObserver(()=>{this.logger.debug("mutation observed"),this.scheduleScan("mutation")}),this.audioController=new Y({window:this.window,logger:this.verboseLogger})}async start(){await this.refreshVerboseFlag(),this.logger.info("bootstrap content script"),this.observeMutations(),this.unsubscribeBackground=W(t=>this.handleBackgroundEvent(t),this.verboseLogger),await this.scanNow("startup"),await this.sendHeartbeat(!1),this.scheduleHeartbeat()}destroy(){var t,e;this.isDestroyed||(this.isDestroyed=!0,this.logger.info("destroy runtime"),this.mutationObserver.disconnect(),this.unsubscribeBackground&&this.unsubscribeBackground(),this.zeroTimer&&clearTimeout(this.zeroTimer),this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.idleHandle&&((e=(t=this.window).cancelIdleCallback)==null||e.call(t,this.idleHandle)))}observeMutations(){const t=this.window.document.documentElement;t&&this.mutationObserver.observe(t,{subtree:!0,childList:!0,attributes:!0})}createVerbosityAwareLogger(){return A("codex-content",{debug:(...e)=>{this.verbose&&console.debug(...e)},info:(...e)=>console.info(...e),warn:(...e)=>console.warn(...e),error:(...e)=>console.error(...e)})}async readVerboseFlag(){try{return!!(await h().storage.session.get({[T]:!1}))[T]}catch(t){return this.logger.debug("verbose flag read failed",t),!1}}async refreshVerboseFlag(){this.verbose=await this.readVerboseFlag()}scheduleScan(t){var e,i;this.isDestroyed||this.idleHandle||(this.logger.debug("schedule scan",t),this.idleHandle=(i=(e=this.window).requestIdleCallback)==null?void 0:i.call(e,()=>{this.idleHandle=void 0,this.scanNow(t).catch(n=>{this.logger.error("scan failed",n)})},{timeout:500}))}async scanNow(t){if(this.isDestroyed)return;const e=Date.now();if(t!=="ping"&&e-this.lastScanAt<X){this.logger.debug("scan throttled");return}this.lastScanAt=e;const i=tt(this.window.location),n=this.supportsScanning;i!==n&&(this.logger.debug("location support changed",{supportsScanning:i,href:this.window.location.href}),i&&this.scanner.reset(),this.supportsScanning=i);const r=i?this.scanner.scan(e):et(e);this.lastSnapshot=r;const o=n===!0&&i===!1;await this.dispatchSnapshot(r,{bypassZeroDebounce:o})}async dispatchSnapshot(t,e={}){if(this.isDestroyed)return;const i=e.bypassZeroDebounce??!1;if(t.count===0&&!t.active){if(this.lastSentSnapshot&&this.lastSentSnapshot.count===0)return;if(this.zeroTimer&&clearTimeout(this.zeroTimer),i){this.zeroTimer=void 0,await this.sendUpdate(t);return}this.zeroTimer=setTimeout(()=>{this.zeroTimer=void 0,this.sendUpdate(t).catch(n=>{this.logger.error("zero debounce send failed",n)})},J);return}this.zeroTimer&&(clearTimeout(this.zeroTimer),this.zeroTimer=void 0),await this.sendUpdate(t)}async sendUpdate(t){const e={type:"TASKS_UPDATE",origin:this.window.location.href,active:t.active,count:t.count,signals:t.signals,ts:Date.now()};k(e),await p(e,this.logger),this.lastSentSnapshot=t,this.lastUpdateTs=e.ts}async sendHeartbeat(t){var i;const e={type:"TASKS_HEARTBEAT",origin:this.window.location.href,ts:Date.now(),lastUpdateTs:this.lastUpdateTs||((i=this.lastSnapshot)==null?void 0:i.ts)||Date.now(),intervalMs:E,...t?{respondingToPing:!0}:{}};L(e),await p(e,this.logger)}scheduleHeartbeat(){this.isDestroyed||(this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.heartbeatTimer=setTimeout(()=>{this.sendHeartbeat(!1).catch(t=>{this.logger.error("heartbeat failed",t)}).finally(()=>{this.scheduleHeartbeat()})},E))}async handleBackgroundEvent(t){switch(t.type){case"PING":await this.scanNow("ping"),await this.sendHeartbeat(!0),this.scheduleHeartbeat();break;case"RESET":this.scanner.reset(),await this.refreshVerboseFlag(),await this.scanNow("manual");break;case"REQUEST_STATE":this.lastSnapshot?await this.sendUpdate(this.lastSnapshot):await this.scanNow("manual");break;case"AUDIO_CHIME":{const e=typeof t.volume=="number"?t.volume:void 0;await this.audioController.handleChimeRequest(e);break}case"AUDIO_SETTINGS_UPDATE":{const e=typeof t.sound=="boolean"?t.sound:void 0,i=typeof t.soundVolume=="number"?t.soundVolume:void 0;this.audioController.applySettings({sound:e,soundVolume:i});break}}}}let l;async function st(){l||(l=new it({window}),await l.start())}st();
