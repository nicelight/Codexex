import{a as u,r as d,g as _,c as k,e as L,f as N}from"../assets/chrome-CDKoC93C.js";class I{constructor(t,e){this.pipeline=t,this.logger=u(e,"scanner")}reset(){this.logger.info("reset pipeline"),this.pipeline.reset()}scan(t){const e=this.pipeline.createContext(t);let s=!1,i=0;const r=[];for(const o of this.pipeline.detectors){const a=o.scan(e);s=s||a.active,i=Math.max(i,a.count),O(r,a)}const c={active:s,count:i,signals:r,ts:t};return this.logger.debug("scan result",c),c}}function O(n,t){for(const e of t.signals)n.find(i=>i.detector===e.detector&&i.evidence===e.evidence&&i.taskKey===e.taskKey)||n.push(e)}function p(n){var s,i,r;const t=(s=n.documentElement.lang)==null?void 0:s.trim().toLowerCase();if(t!=null&&t.startsWith("ru"))return"ru";const e=(r=(i=n.defaultView)==null?void 0:i.navigator.language)==null?void 0:r.toLowerCase();return e!=null&&e.startsWith("ru")?"ru":"en"}function A(n){const t=n.tagName.toLowerCase(),e=n.id?`#${n.id}`:"",s=Array.from(n.classList||[]).slice(0,3).map(i=>`.${i}`).join("");return`${t}${e}${s}`||t}function U(n,t){const e=[];for(const s of t){const i=n.querySelectorAll(s);e.push(...Array.from(i))}return e}function v(n,t,e,s,i){n.debug(`${t} scan`,JSON.stringify({active:e,count:s,evidences:i}))}class B{constructor(t){this.options=t,this.id="D3_CARD_HEUR"}scan(t){return t.logger.debug(`${this.id} disabled`,JSON.stringify({enabled:this.options.enabled})),{active:!1,count:0,signals:[]}}}function R(n){return new B(n)}const H=['[aria-busy="true"]','[role="progressbar"]',".animate-spin",".loading-spinner",'svg[role="img"] animateTransform'];function x(n){const t=new Set,e=[];for(const s of n)t.has(s)||(t.add(s),e.push(s));return e}function M(n){return n.slice(0,5).map((t,e)=>({detector:"D1_SPINNER",evidence:`${A(t)}#${e}`}))}class V{constructor(){this.id="D1_SPINNER"}scan(t){const e=x(U(t.root,H)),s=e.length>0,i=s?Math.max(1,e.length):0,r=s?M(e):[];return v(t.logger,this.id,s,i,r.map(c=>c.evidence)),{active:s,count:i,signals:r}}}function P(){return new V}const z={en:["stop","stop run","cancel","cancel run","cancel task"],ru:["остановить","прервать","отменить","отменить задачу"]},$=["button",'[role="button"]',"a[href]"],K=["codex-stop","task-stop","stop-task","stop_run","stop-run","run-stop","cancel-task","task-cancel"],m=new Set(["task","run","execution","workflow","flow","card","button"]);function q(n){return n.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([A-Z])([A-Z][a-z])/g,"$1 $2").toLowerCase().split(/[^a-z0-9]+/).map(e=>e.trim()).filter(e=>e.length>0)}function F(n){const t=n.toLowerCase();if(K.some(s=>t.includes(s)))return!0;const e=q(n);return!e.includes("stop")&&!e.includes("cancel")?!1:e.includes("cancel")?e.some(s=>s!=="cancel"&&m.has(s)):e.some(s=>s!=="stop"&&m.has(s))}function W(n){return n.replace(/\s+/g," ").trim().toLowerCase()}function l(n,t){const e=W(n);return z[t].some(i=>e.includes(i))}function G(n,t){const e=n.textContent??"";if(e&&l(e,t))return!0;if(n instanceof HTMLButtonElement||n instanceof HTMLAnchorElement){const i=n.getAttribute("title");if(i&&l(i,t))return!0;const r=n.getAttribute("aria-label");if(r&&l(r,t))return!0}const s=n.getAttribute("data-testid");return!!(s&&F(s))}function w(n){let t=n;const e=new Set;for(;t&&!e.has(t);){e.add(t);const s=t.getAttribute("data-task-id")??t.getAttribute("data-id")??t.getAttribute("data-reactid");if(s)return s;t=t.parentElement}}class j{constructor(){this.id="D2_STOP_BUTTON",this.cache=new WeakSet}bootstrap(){this.cache=new WeakSet}scan(t){const s=Array.from(t.root.querySelectorAll($.join(","))).filter(o=>{if(this.cache.has(o))return!0;const a=G(o,t.locale);return a&&this.cache.add(o),a}),i=s.slice(0,10).map((o,a)=>({detector:"D2_STOP_BUTTON",evidence:`${A(o)}#${a}`,...w(o)?{taskKey:w(o)}:{}})),r=s.length>0,c=r?s.length:0;return v(t.logger,this.id,r,c,i.map(o=>o.evidence)),{active:r,count:c,signals:i}}teardown(){this.cache=new WeakSet}}function Z(){return new j}function Q(n){const t=[P(),Z(),R({enabled:!!n.enableCardHeuristic})];let e=p(n.document);const s=r=>(e=p(n.document),{document:n.document,root:n.document.documentElement,locale:e,now:r,logger:n.logger}),i=()=>{var r,c;for(const o of t)(r=o.teardown)==null||r.call(o),(c=o.bootstrap)==null||c.call(o,s(Date.now()))};return i(),{detectors:t,createContext:s,reset:i}}function Y(n){return new Promise(t=>n(t))}async function b(n,t){const e=d();t.debug("post message",n),await Y(s=>{try{e.runtime.sendMessage(n,()=>{const i=e.runtime.lastError;i&&t.warn("sendMessage error",i.message),s()})}catch(i){t.error("sendMessage threw",i),s()}})}function J(n){if(!n||typeof n!="object")return;const{type:t}=n;if(t==="PING"||t==="RESET"||t==="REQUEST_STATE")return{type:t};if(t==="AUDIO_CHIME"){const{volume:e}=n;return{type:"AUDIO_CHIME",volume:typeof e=="number"?e:void 0}}if(t==="AUDIO_PREVIEW"){const{volume:e}=n;return{type:"AUDIO_PREVIEW",volume:typeof e=="number"?e:void 0}}if(t==="AUDIO_SETTINGS_UPDATE"){const{sound:e,soundVolume:s}=n;return{type:"AUDIO_SETTINGS_UPDATE",...typeof e=="boolean"?{sound:e}:{},...typeof s=="number"?{soundVolume:s}:{}}}}function X(n,t){const e=d(),s=u(t,"background-listener"),i=(r,c)=>{const o=J(r);if(o){s.debug("received event",o);try{const a=n(o,c);a&&typeof a.then=="function"&&a.catch(D=>{s.error("handler rejected",D)})}catch(a){s.error("handler threw",a)}}};return e.runtime.onMessage.addListener(i),()=>{e.runtime.onMessage.removeListener(i)}}const tt="media/oh-oh-icq-sound.mp3",C=.2,T=.02,f=.35,et=880;class st{constructor(t){this.chrome=d(),this.pending=!1,this.unlocked=!1,this.initialized=!1,this.volume=C,this.enabled=!0,this.window=t.window,this.logger=u(t.logger,"audio"),this.window.addEventListener("pointerdown",()=>{this.unlock()},{once:!0,capture:!0}),this.window.addEventListener("keydown",()=>{this.unlock()},{once:!0,capture:!0})}async ensureInitialized(){this.initialized||(this.initialized=!0,await this.unlock())}async unlock(){if(!(typeof this.window.AudioContext>"u"||this.unlocked))try{this.audioContext=new this.window.AudioContext,this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=0,this.gainNode.connect(this.audioContext.destination),this.unlocked=!0,this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.pending&&(this.pending=!1,await this.ensureAudioBuffer(),await this.playChime())}catch(t){this.logger.warn("audio unlock failed",t)}}applySettings(t){typeof t.sound=="boolean"&&(this.enabled=t.sound),typeof t.soundVolume=="number"&&(this.volume=g(t.soundVolume))}async handleChimeRequest(t){if(!this.enabled){this.pending=!1;return}if(!this.unlocked){this.pending=!0;return}await this.ensureAudioBuffer(),await this.playChime(t)}async ensureAudioBuffer(){if(this.audioBuffer||!this.audioContext)return;const t=this.chrome.runtime.getURL(tt);try{const e=await fetch(t);if(!e.ok)throw new Error(`fetch status ${e.status}`);const s=await e.arrayBuffer();this.audioBuffer=await this.decodeAudioData(s)}catch(e){this.logger.debug("audio buffer load failed",e)}}async decodeAudioData(t){if(this.audioContext&&typeof this.audioContext.decodeAudioData=="function")return this.audioContext.decodeAudioData(t)}async playChime(t){if(!this.audioContext||!this.gainNode){this.pending=!0;return}const e=g(typeof t=="number"?t:this.volume);if(!(e<=0)){if(this.audioBuffer){this.playBuffer(e);return}this.playOscillator(e)}}playBuffer(t){if(!this.audioContext||!this.gainNode||!this.audioBuffer){this.pending=!0;return}const e=this.audioContext,s=e.createBufferSource();s.buffer=this.audioBuffer,s.connect(this.gainNode),S(e,this.gainNode,t),s.start(e.currentTime),s.stop(e.currentTime+f+.1),s.addEventListener("ended",()=>{s.disconnect()})}playOscillator(t){if(!this.audioContext||!this.gainNode){this.pending=!0;return}const e=this.audioContext,s=e.createOscillator();s.type="triangle",s.frequency.value=et,s.connect(this.gainNode),S(e,this.gainNode,t),s.start(e.currentTime),s.stop(e.currentTime+f+.1),s.addEventListener("ended",()=>{s.disconnect()})}}function S(n,t,e){const s=n.currentTime;t.gain.cancelScheduledValues(s);const i=g(e);t.gain.setValueAtTime(0,s),t.gain.linearRampToValueAtTime(i,s+T),t.gain.linearRampToValueAtTime(0,s+T+f)}function g(n){return Number.isFinite(n)?n<=0?0:n>=1?1:n:C}const nt=500,E=15e3,it=1e3,y="codex.tasks.verbose";class rt{constructor(t){this.lastUpdateTs=0,this.lastScanAt=0,this.isDestroyed=!1,this.verbose=!1,this.window=t.window,_(this.window),this.verboseLogger=this.createVerbosityAwareLogger(),this.logger=u(this.verboseLogger,"runtime");const e=Q({document:this.window.document,logger:u(this.verboseLogger,"detectors"),enableCardHeuristic:!1});this.scanner=new I(e,this.verboseLogger),this.mutationObserver=new MutationObserver(()=>{this.logger.debug("mutation observed"),this.scheduleScan("mutation")}),this.audioController=new st({window:this.window,logger:this.verboseLogger})}async start(){await this.refreshVerboseFlag(),this.logger.info("bootstrap content script"),this.observeMutations(),this.unsubscribeBackground=X(t=>this.handleBackgroundEvent(t),this.verboseLogger),await this.scanNow("startup"),await this.sendHeartbeat(!1),this.scheduleHeartbeat()}destroy(){var t,e;this.isDestroyed||(this.isDestroyed=!0,this.logger.info("destroy runtime"),this.mutationObserver.disconnect(),this.unsubscribeBackground&&this.unsubscribeBackground(),this.zeroTimer&&clearTimeout(this.zeroTimer),this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.idleHandle&&((e=(t=this.window).cancelIdleCallback)==null||e.call(t,this.idleHandle)))}observeMutations(){const t=this.window.document.documentElement;t&&this.mutationObserver.observe(t,{subtree:!0,childList:!0,attributes:!0})}createVerbosityAwareLogger(){return k("codex-content",{debug:(...e)=>{this.verbose&&console.debug(...e)},info:(...e)=>console.info(...e),warn:(...e)=>console.warn(...e),error:(...e)=>console.error(...e)})}async readVerboseFlag(){try{return!!(await d().storage.session.get({[y]:!1}))[y]}catch(t){return this.logger.debug("verbose flag read failed",t),!1}}async refreshVerboseFlag(){this.verbose=await this.readVerboseFlag()}scheduleScan(t){var e,s;this.isDestroyed||this.idleHandle||(this.logger.debug("schedule scan",t),this.idleHandle=(s=(e=this.window).requestIdleCallback)==null?void 0:s.call(e,()=>{this.idleHandle=void 0,this.scanNow(t).catch(i=>{this.logger.error("scan failed",i)})},{timeout:500}))}async scanNow(t){if(this.isDestroyed)return;const e=Date.now();if(t!=="ping"&&e-this.lastScanAt<it){this.logger.debug("scan throttled");return}this.lastScanAt=e;const s=this.scanner.scan(e);this.lastSnapshot=s,await this.dispatchSnapshot(s)}async dispatchSnapshot(t){if(!this.isDestroyed){if(t.count===0&&!t.active){if(this.lastSentSnapshot&&this.lastSentSnapshot.count===0)return;this.zeroTimer&&clearTimeout(this.zeroTimer),this.zeroTimer=setTimeout(()=>{this.zeroTimer=void 0,this.sendUpdate(t).catch(e=>{this.logger.error("zero debounce send failed",e)})},nt);return}this.zeroTimer&&(clearTimeout(this.zeroTimer),this.zeroTimer=void 0),await this.sendUpdate(t)}}async sendUpdate(t){const e={type:"TASKS_UPDATE",origin:this.window.location.href,active:t.active,count:t.count,signals:t.signals,ts:Date.now()};L(e),await b(e,this.logger),this.lastSentSnapshot=t,this.lastUpdateTs=e.ts}async sendHeartbeat(t){var s;const e={type:"TASKS_HEARTBEAT",origin:this.window.location.href,ts:Date.now(),lastUpdateTs:this.lastUpdateTs||((s=this.lastSnapshot)==null?void 0:s.ts)||Date.now(),intervalMs:E,...t?{respondingToPing:!0}:{}};N(e),await b(e,this.logger)}scheduleHeartbeat(){this.isDestroyed||(this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.heartbeatTimer=setTimeout(()=>{this.sendHeartbeat(!1).catch(t=>{this.logger.error("heartbeat failed",t)}).finally(()=>{this.scheduleHeartbeat()})},E))}async handleBackgroundEvent(t){switch(t.type){case"PING":await this.scanNow("ping"),await this.sendHeartbeat(!0),this.scheduleHeartbeat();break;case"RESET":this.scanner.reset(),await this.refreshVerboseFlag(),await this.scanNow("manual");break;case"REQUEST_STATE":this.lastSnapshot?await this.sendUpdate(this.lastSnapshot):await this.scanNow("manual");break;case"AUDIO_CHIME":await this.audioController.handleChimeRequest(t.volume);break;case"AUDIO_SETTINGS_UPDATE":this.audioController.applySettings({sound:t.sound,soundVolume:t.soundVolume});break}}}let h;async function ot(){h||(h=new rt({window}),await h.start())}ot();
