import{a as u,r as d,g as L,c as D,e as _,f as N}from"../assets/chrome-CWUhAqIv.js";import{n as U,i as I,a as O}from"../assets/url-odDJkPYl.js";class R{constructor(e,t){this.pipeline=e,this.logger=u(t,"scanner")}reset(){this.logger.info("reset pipeline"),this.pipeline.reset()}scan(e){const t=this.pipeline.createContext(e);let s=!1,i=0;const r=[];for(const o of this.pipeline.detectors){const c=o.scan(t);s=s||c.active,i=Math.max(i,c.count),x(r,c)}const a={active:s,count:i,signals:r,ts:e};return this.logger.debug("scan result",a),a}}function x(n,e){for(const t of e.signals)n.find(i=>i.detector===t.detector&&i.evidence===t.evidence&&i.taskKey===t.taskKey)||n.push(t)}function w(n){var s,i,r;const e=(s=n.documentElement.lang)==null?void 0:s.trim().toLowerCase();if(e!=null&&e.startsWith("ru"))return"ru";const t=(r=(i=n.defaultView)==null?void 0:i.navigator.language)==null?void 0:r.toLowerCase();return t!=null&&t.startsWith("ru")?"ru":"en"}function p(n){const e=n.tagName.toLowerCase(),t=n.id?`#${n.id}`:"",s=Array.from(n.classList||[]).slice(0,3).map(i=>`.${i}`).join("");return`${e}${t}${s}`||e}function H(n,e){const t=[];for(const s of e){const i=n.querySelectorAll(s);t.push(...Array.from(i))}return t}function m(n,e,t,s,i){n.debug(`${e} scan`,JSON.stringify({active:t,count:s,evidences:i}))}class B{constructor(e){this.options=e,this.id="D3_CARD_HEUR"}scan(e){return e.logger.debug(`${this.id} disabled`,JSON.stringify({enabled:this.options.enabled})),{active:!1,count:0,signals:[]}}}function V(n){return new B(n)}const M=['[aria-busy="true"]','[role="progressbar"]',".animate-spin",".loading-spinner",'svg[role="img"] animateTransform'];function P(n){const e=new Set,t=[];for(const s of n)e.has(s)||(e.add(s),t.push(s));return t}function z(n){return n.slice(0,5).map((e,t)=>({detector:"D1_SPINNER",evidence:`${p(e)}#${t}`}))}class ${constructor(){this.id="D1_SPINNER"}scan(e){const t=P(H(e.root,M)),s=t.length>0,i=s?Math.max(1,t.length):0,r=s?z(t):[];return m(e.logger,this.id,s,i,r.map(a=>a.evidence)),{active:s,count:i,signals:r}}}function K(){return new $}const F={en:["stop","stop run","cancel","cancel run","cancel task"],ru:["остановить","прервать","отменить","отменить задачу"]},q=["button",'[role="button"]',"a[href]"];function W(n){if(n instanceof HTMLButtonElement&&n.disabled)return!0;const e=n.getAttribute("aria-disabled");return typeof e=="string"&&e.toLowerCase()==="true"}function G(n,e){var s;let t=n;for(;t;){if(t instanceof HTMLElement){if(t.hidden)return!1;const i=t.getAttribute("aria-hidden");if(typeof i=="string"&&i.toLowerCase()==="true")return!1;const r=((s=t.ownerDocument)==null?void 0:s.defaultView)??e.defaultView;if(r){const a=r.getComputedStyle(t);if(a.display==="none"||a.visibility==="hidden"||Number.parseFloat(a.opacity||"1")===0)return!1}}t=t.parentElement}return!0}const Z=["codex-stop","task-stop","stop-task","stop_run","stop-run","run-stop","cancel-task","task-cancel"],b=new Set(["task","run","execution","workflow","flow","card","button"]);function j(n){return n.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([A-Z])([A-Z][a-z])/g,"$1 $2").toLowerCase().split(/[^a-z0-9]+/).map(t=>t.trim()).filter(t=>t.length>0)}function Q(n){const e=n.toLowerCase();if(Z.some(s=>e.includes(s)))return!0;const t=j(n);return!t.includes("stop")&&!t.includes("cancel")?!1:t.includes("cancel")?t.some(s=>s!=="cancel"&&b.has(s)):t.some(s=>s!=="stop"&&b.has(s))}function Y(n){return n.replace(/\s+/g," ").trim().toLowerCase()}function l(n,e){const t=Y(n);return F[e].some(i=>t.includes(i))}function J(n,e){const t=n.textContent??"";if(t&&l(t,e))return!0;if(n instanceof HTMLButtonElement||n instanceof HTMLAnchorElement){const i=n.getAttribute("title");if(i&&l(i,e))return!0;const r=n.getAttribute("aria-label");if(r&&l(r,e))return!0}const s=n.getAttribute("data-testid");return!!(s&&Q(s))}function T(n){let e=n;const t=new Set;for(;e&&!t.has(e);){t.add(e);const s=e.getAttribute("data-task-id")??e.getAttribute("data-id")??e.getAttribute("data-reactid");if(s)return s;e=e.parentElement}}class X{constructor(){this.id="D2_STOP_BUTTON",this.cache=new WeakSet}bootstrap(){this.cache=new WeakSet}scan(e){const s=Array.from(e.root.querySelectorAll(q.join(","))).filter(o=>{if(this.cache.has(o))return!0;if(!G(o,e.document)||W(o))return!1;const c=J(o,e.locale);return c&&this.cache.add(o),c}),i=s.slice(0,10).map((o,c)=>({detector:"D2_STOP_BUTTON",evidence:`${p(o)}#${c}`,...T(o)?{taskKey:T(o)}:{}})),r=s.length>0,a=r?s.length:0;return m(e.logger,this.id,r,a,i.map(o=>o.evidence)),{active:r,count:a,signals:i}}teardown(){this.cache=new WeakSet}}function ee(){return new X}const te="div.absolute.inset-0.flex.items-center.justify-center";function se(n){var s;const e=(s=n.textContent)==null?void 0:s.trim();if(!e)return;const t=e.match(/\d+/);if(t)return Number.parseInt(t[0]??"",10)}class ne{constructor(){this.id="D4_TASK_COUNTER"}scan(e){const t=Array.from(e.root.querySelectorAll(te));let s=0;const i=[];t.forEach((a,o)=>{const c=se(a);typeof c=="number"&&Number.isFinite(c)&&(s=Math.max(s,c),i.push({detector:this.id,evidence:`${p(a)}#${o}`}))});const r=s>0;return m(e.logger,this.id,r,s,i.map(a=>a.evidence)),{active:r,count:s,signals:i}}}function ie(){return new ne}function re(n){const e=[ie(),K(),ee(),V({enabled:!!n.enableCardHeuristic})];let t=w(n.document);const s=r=>(t=w(n.document),{document:n.document,root:n.document.documentElement,locale:t,now:r,logger:n.logger}),i=()=>{var r,a;for(const o of e)(r=o.teardown)==null||r.call(o),(a=o.bootstrap)==null||a.call(o,s(Date.now()))};return i(),{detectors:e,createContext:s,reset:i}}function oe(n){return new Promise(e=>n(e))}async function E(n,e){var s;const t=d();if(!((s=t.runtime)!=null&&s.id)){e.warn("runtime unavailable, skipping message (runtime-id-missing)");return}e.debug("post message",n),await oe(i=>{try{t.runtime.sendMessage(n,()=>{const r=t.runtime.lastError;r&&e.warn("sendMessage error",r.message),i()})}catch(r){e.error("sendMessage threw",r),i()}})}function ae(n){if(!n||typeof n!="object")return;const{type:e}=n;if(e==="PING"||e==="RESET"||e==="REQUEST_STATE")return{type:e};if(e==="AUDIO_CHIME"){const{volume:t}=n;return{type:"AUDIO_CHIME",volume:typeof t=="number"?t:void 0}}if(e==="AUDIO_PREVIEW"){const{volume:t}=n;return{type:"AUDIO_PREVIEW",volume:typeof t=="number"?t:void 0}}if(e==="AUDIO_SETTINGS_UPDATE"){const{sound:t,soundVolume:s}=n;return{type:"AUDIO_SETTINGS_UPDATE",...typeof t=="boolean"?{sound:t}:{},...typeof s=="number"?{soundVolume:s}:{}}}}function ce(n,e){const t=d(),s=u(e,"background-listener"),i=(r,a)=>{const o=ae(r);if(o){s.debug("received event",o);try{const c=n(o,a);c&&typeof c.then=="function"&&c.catch(k=>{s.error("handler rejected",k)})}catch(c){s.error("handler threw",c)}}};return t.runtime.onMessage.addListener(i),()=>{t.runtime.onMessage.removeListener(i)}}const ue="media/oh-oh-icq-sound.mp3",C=.2,S=.02,f=.35,de=880;class le{constructor(e){this.chrome=d(),this.pending=!1,this.unlocked=!1,this.initialized=!1,this.unlockListenersAttached=!1,this.volume=C,this.enabled=!0,this.window=e.window,this.logger=u(e.logger,"audio"),this.unlockEventHandler=()=>{this.detachUnlockListeners(),this.unlock()},this.attachUnlockListeners()}async ensureInitialized(){this.initialized||(this.initialized=!0,this.attachUnlockListeners())}async unlock(){if(this.detachUnlockListeners(),!(typeof this.window.AudioContext>"u")){if(this.unlocked){await this.resumeContextIfNeeded();return}try{this.audioContext=new this.window.AudioContext,this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=0,this.gainNode.connect(this.audioContext.destination),this.unlocked=!0,this.unlockListenersAttached=!1,await this.resumeContextIfNeeded(),this.pending&&(this.pending=!1,await this.ensureAudioBuffer(),await this.playChime())}catch(e){this.logger.warn("audio unlock failed",e),this.attachUnlockListeners()}}}applySettings(e){typeof e.sound=="boolean"&&(this.enabled=e.sound),typeof e.soundVolume=="number"&&(this.volume=g(e.soundVolume))}async handleChimeRequest(e){if(!this.enabled){this.pending=!1;return}if(!this.unlocked){this.pending=!0,this.attachUnlockListeners();return}await this.resumeContextIfNeeded(),await this.ensureAudioBuffer(),await this.playChime(e)}attachUnlockListeners(){this.unlocked||this.unlockListenersAttached||(this.unlockListenersAttached=!0,this.window.addEventListener("pointerdown",this.unlockEventHandler,{capture:!0}),this.window.addEventListener("keydown",this.unlockEventHandler,{capture:!0}))}detachUnlockListeners(){this.unlockListenersAttached&&(this.window.removeEventListener("pointerdown",this.unlockEventHandler,!0),this.window.removeEventListener("keydown",this.unlockEventHandler,!0),this.unlockListenersAttached=!1)}async resumeContextIfNeeded(){if(this.audioContext&&this.audioContext.state==="suspended")try{await this.audioContext.resume()}catch(e){this.logger.debug("audio resume failed",e)}}async ensureAudioBuffer(){if(this.audioBuffer||!this.audioContext)return;const e=this.chrome.runtime.getURL(ue);try{const t=await fetch(e);if(!t.ok)throw new Error(`fetch status ${t.status}`);const s=await t.arrayBuffer();this.audioBuffer=await this.decodeAudioData(s)}catch(t){this.logger.debug("audio buffer load failed",t)}}async decodeAudioData(e){if(this.audioContext&&typeof this.audioContext.decodeAudioData=="function")return this.audioContext.decodeAudioData(e)}async playChime(e){if(!this.audioContext||!this.gainNode){this.pending=!0;return}const t=g(typeof e=="number"?e:this.volume);if(!(t<=0)){if(this.audioBuffer){this.playBuffer(t);return}this.playOscillator(t)}}playBuffer(e){if(!this.audioContext||!this.gainNode||!this.audioBuffer){this.pending=!0;return}const t=this.audioContext,s=t.createBufferSource();s.buffer=this.audioBuffer,s.connect(this.gainNode),y(t,this.gainNode,e),s.start(t.currentTime),s.stop(t.currentTime+f+.1),s.addEventListener("ended",()=>{s.disconnect()})}playOscillator(e){if(!this.audioContext||!this.gainNode){this.pending=!0;return}const t=this.audioContext,s=t.createOscillator();s.type="triangle",s.frequency.value=de,s.connect(this.gainNode),y(t,this.gainNode,e),s.start(t.currentTime),s.stop(t.currentTime+f+.1),s.addEventListener("ended",()=>{s.disconnect()})}}function y(n,e,t){const s=n.currentTime;e.gain.cancelScheduledValues(s);const i=g(t);e.gain.setValueAtTime(0,s),e.gain.linearRampToValueAtTime(i,s+S),e.gain.linearRampToValueAtTime(0,s+S+f)}function g(n){return Number.isFinite(n)?n<=0?0:n>=1?1:n:C}const he=500,v=15e3,fe=1e3,A="codex.tasks.verbose";function ge(n){const e=U((n==null?void 0:n.pathname)??"/");return I(e)||O(e)}function pe(n){return{active:!1,count:0,signals:[],ts:n}}class me{constructor(e){this.lastUpdateTs=0,this.lastScanAt=0,this.isDestroyed=!1,this.verbose=!1,this.window=e.window,L(this.window),this.verboseLogger=this.createVerbosityAwareLogger(),this.logger=u(this.verboseLogger,"runtime");const t=re({document:this.window.document,logger:u(this.verboseLogger,"detectors"),enableCardHeuristic:!1});this.scanner=new R(t,this.verboseLogger),this.mutationObserver=new MutationObserver(()=>{this.logger.debug("mutation observed"),this.scheduleScan("mutation")}),this.audioController=new le({window:this.window,logger:this.verboseLogger})}async start(){await this.refreshVerboseFlag(),this.logger.info("bootstrap content script"),this.observeMutations(),this.unsubscribeBackground=ce(e=>this.handleBackgroundEvent(e),this.verboseLogger),await this.scanNow("startup"),await this.sendHeartbeat(!1),this.scheduleHeartbeat()}destroy(){var e,t;this.isDestroyed||(this.isDestroyed=!0,this.logger.info("destroy runtime"),this.mutationObserver.disconnect(),this.unsubscribeBackground&&this.unsubscribeBackground(),this.zeroTimer&&clearTimeout(this.zeroTimer),this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.idleHandle&&((t=(e=this.window).cancelIdleCallback)==null||t.call(e,this.idleHandle)))}observeMutations(){const e=this.window.document.documentElement;e&&this.mutationObserver.observe(e,{subtree:!0,childList:!0,attributes:!0})}createVerbosityAwareLogger(){return D("codex-content",{debug:(...t)=>{this.verbose&&console.debug(...t)},info:(...t)=>console.info(...t),warn:(...t)=>console.warn(...t),error:(...t)=>console.error(...t)})}async readVerboseFlag(){try{return!!(await d().storage.session.get({[A]:!1}))[A]}catch(e){return this.logger.debug("verbose flag read failed",e),!1}}async refreshVerboseFlag(){this.verbose=await this.readVerboseFlag()}scheduleScan(e){var t,s;this.isDestroyed||this.idleHandle||(this.logger.debug("schedule scan",e),this.idleHandle=(s=(t=this.window).requestIdleCallback)==null?void 0:s.call(t,()=>{this.idleHandle=void 0,this.scanNow(e).catch(i=>{this.logger.error("scan failed",i)})},{timeout:500}))}async scanNow(e){if(this.isDestroyed)return;const t=Date.now();if(e!=="ping"&&t-this.lastScanAt<fe){this.logger.debug("scan throttled");return}this.lastScanAt=t;const s=ge(this.window.location),i=this.supportsScanning;s!==i&&(this.logger.debug("location support changed",{supportsScanning:s,href:this.window.location.href}),s&&this.scanner.reset(),this.supportsScanning=s);const r=s?this.scanner.scan(t):pe(t);this.lastSnapshot=r;const a=i===!0&&s===!1;await this.dispatchSnapshot(r,{bypassZeroDebounce:a})}async dispatchSnapshot(e,t={}){if(this.isDestroyed)return;const s=t.bypassZeroDebounce??!1;if(e.count===0&&!e.active){if(this.lastSentSnapshot&&this.lastSentSnapshot.count===0)return;if(this.zeroTimer&&clearTimeout(this.zeroTimer),s){this.zeroTimer=void 0,await this.sendUpdate(e);return}this.zeroTimer=setTimeout(()=>{this.zeroTimer=void 0,this.sendUpdate(e).catch(i=>{this.logger.error("zero debounce send failed",i)})},he);return}this.zeroTimer&&(clearTimeout(this.zeroTimer),this.zeroTimer=void 0),await this.sendUpdate(e)}async sendUpdate(e){const t={type:"TASKS_UPDATE",origin:this.window.location.href,active:e.active,count:e.count,signals:e.signals,ts:Date.now()};_(t),await E(t,this.logger),this.lastSentSnapshot=e,this.lastUpdateTs=t.ts}async sendHeartbeat(e){var s;const t={type:"TASKS_HEARTBEAT",origin:this.window.location.href,ts:Date.now(),lastUpdateTs:this.lastUpdateTs||((s=this.lastSnapshot)==null?void 0:s.ts)||Date.now(),intervalMs:v,...e?{respondingToPing:!0}:{}};N(t),await E(t,this.logger)}scheduleHeartbeat(){this.isDestroyed||(this.heartbeatTimer&&clearTimeout(this.heartbeatTimer),this.heartbeatTimer=setTimeout(()=>{this.sendHeartbeat(!1).catch(e=>{this.logger.error("heartbeat failed",e)}).finally(()=>{this.scheduleHeartbeat()})},v))}async handleBackgroundEvent(e){switch(e.type){case"PING":await this.scanNow("ping"),await this.sendHeartbeat(!0),this.scheduleHeartbeat();break;case"RESET":this.scanner.reset(),await this.refreshVerboseFlag(),await this.scanNow("manual");break;case"REQUEST_STATE":this.lastSnapshot?await this.sendUpdate(this.lastSnapshot):await this.scanNow("manual");break;case"AUDIO_CHIME":await this.audioController.handleChimeRequest(e.volume);break;case"AUDIO_SETTINGS_UPDATE":this.audioController.applySettings({sound:e.sound,soundVolume:e.soundVolume});break}}}let h;async function we(){h||(h=new me({window}),await h.start())}we();
