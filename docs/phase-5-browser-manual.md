# Р—Р°РїСѓСЃРє Рё СЂСѓС‡РЅР°СЏ РїСЂРѕРІРµСЂРєР° Chrome-СЂР°СЃС€РёСЂРµРЅРёСЏ Codex Tasks Watcher

> Р­С‚РѕС‚ РґРѕРєСѓРјРµРЅС‚ РґРѕРїРѕР»РЅСЏРµС‚ СЂСѓРєРѕРІРѕРґСЃС‚РІРѕ РїРѕ Р¤Р°Р·Рµ 5 Рё РѕР±СЉСЏСЃРЅСЏРµС‚, РєР°Рє СЃРѕР±СЂР°С‚СЊ РїСЂРѕРµРєС‚, Р·Р°РіСЂСѓР·РёС‚СЊ СЂР°СЃС€РёСЂРµРЅРёРµ РІ Р±СЂР°СѓР·РµСЂ Рё С‡С‚Рѕ РїСЂРѕРІРµСЂСЏС‚СЊ РїСЂРё СЂСѓС‡РЅРѕРј С‚РµСЃС‚РёСЂРѕРІР°РЅРёРё. Р’СЃРµ С€Р°РіРё РѕС‚РЅРѕСЃСЏС‚СЃСЏ Рє СЃР±РѕСЂРєРµ Manifest V3, РєРѕС‚РѕСЂР°СЏ Р»РµР¶РёС‚ РІ РєР°С‚Р°Р»РѕРіРµ `extension/`.

## 1. Р§С‚Рѕ РїРѕРЅР°РґРѕР±РёС‚СЃСЏ

- **Р‘СЂР°СѓР·РµСЂ**: Google Chrome 120+ РёР»Рё Chromium-СЃРѕРІРјРµСЃС‚РёРјС‹Р№ Р±СЂР°СѓР·РµСЂ (Manifest V3 РїРѕРґРґРµСЂР¶РёРІР°РµС‚СЃСЏ РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ).
- **Node.js**: РІРµСЂСЃРёСЏ 18 РёР»Рё 20 (СЃРѕРІРјРµСЃС‚РёРјР°СЏ СЃ Vite Рё MV3-РїР»Р°РіРёРЅРѕРј).
- **npm**: РїРѕСЃС‚Р°РІР»СЏРµС‚СЃСЏ РІРјРµСЃС‚Рµ СЃ Node.js.

## 2. РџРѕРґРіРѕС‚РѕРІРєР° СЃР±РѕСЂРєРё

1. Р’С‹РїРѕР»РЅРё СѓСЃС‚Р°РЅРѕРІРєСѓ Р·Р°РІРёСЃРёРјРѕСЃС‚РµР№ (РµСЃР»Рё РЅРµ РґРµР»Р°Р» СЌС‚РѕРіРѕ СЂР°РЅРµРµ):
   ```bash
   npm install
   ```
2. РЎРѕР±РµСЂРё СЂР°СЃС€РёСЂРµРЅРёРµ:
   ```bash
   npm run build
   ```
   - Vite СЃРѕР±РµСЂС‘С‚ РёСЃС…РѕРґРЅРёРєРё РёР· `extension/src/**` Рё РїРѕР»РѕР¶РёС‚ РіРѕС‚РѕРІС‹Р№ РїР°РєРµС‚ РІ РєР°С‚Р°Р»РѕРі `dist/`.
   - РџРµСЂРµРґ РєР°Р¶РґРѕР№ РЅРѕРІРѕР№ СЃР±РѕСЂРєРѕР№ Vite РѕС‡РёС‰Р°РµС‚ `dist/`, РїРѕСЌС‚РѕРјСѓ РЅРµ РґРµСЂР¶Рё С‚Р°Рј СЂСѓС‡РЅС‹С… С„Р°Р№Р»РѕРІ.
3. (РћРїС†РёРѕРЅР°Р»СЊРЅРѕ) Р”Р»СЏ Р±С‹СЃС‚СЂРѕР№ РёС‚РµСЂР°С†РёРё РјРѕР¶РЅРѕ Р·Р°РїСѓСЃС‚РёС‚СЊ СЂРµР¶РёРј СЃР»РµР¶РµРЅРёСЏ:
   ```bash
   npm run dev
   ```
   - РљРѕРјР°РЅРґР° Р·Р°РїСѓСЃРєР°РµС‚ `vite build --watch`, Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё РїРµСЂРµСЃРѕР±РёСЂР°СЋС‰РёР№ `dist/` РїСЂРё РёР·РјРµРЅРµРЅРёСЏС… РёСЃС…РѕРґРЅРёРєРѕРІ.
   - РџРѕСЃР»Рµ РїРµСЂРµСЃР±РѕСЂРєРё РІСЃС‘ СЂР°РІРЅРѕ РЅСѓР¶РЅРѕ РІСЂСѓС‡РЅСѓСЋ В«РѕР±РЅРѕРІРёС‚СЊВ» СЂР°СЃС€РёСЂРµРЅРёРµ РІ Р±СЂР°СѓР·РµСЂРµ.

## 3. Р—Р°РіСЂСѓР·РєР° СЂР°СЃС€РёСЂРµРЅРёСЏ РІ Chrome

1. РћС‚РєСЂРѕР№ `chrome://extensions/`.
2. Р’РєР»СЋС‡Рё **Developer mode** (РїСЂР°РІС‹Р№ РІРµСЂС…РЅРёР№ СѓРіРѕР»).
3. РќР°Р¶РјРё **Load unpacked** в†’ РІС‹Р±РµСЂРё РїР°РїРєСѓ `dist/` РІРЅСѓС‚СЂРё СЂРµРїРѕР·РёС‚РѕСЂРёСЏ.
4. РџСЂРѕРІРµСЂСЊ, С‡С‚Рѕ РІ РєР°СЂС‚РѕС‡РєРµ СЂР°СЃС€РёСЂРµРЅРёСЏ РЅРµС‚ РѕС€РёР±РѕРє:
   - РЎС‚Р°С‚СѓСЃ РґРѕР»Р¶РµРЅ Р±С‹С‚СЊ `This extension is enabled`.
   - РљРЅРѕРїРєР° В«ErrorsВ» РґРѕР»Р¶РЅР° РѕС‚СЃСѓС‚СЃС‚РІРѕРІР°С‚СЊ. Р•СЃР»Рё РїРѕСЏРІР»СЏРµС‚СЃСЏ вЂ” РѕС‚РєСЂРѕР№ Рё СЃРєРѕРїРёСЂСѓР№ СЃС‚РµРє-С‚СЂРµР№СЃ.
5. Р—Р°РїРѕРјРЅРё РёРґРµРЅС‚РёС„РёРєР°С‚РѕСЂ СЂР°СЃС€РёСЂРµРЅРёСЏ (РєРЅРѕРїРєР° **Details** в†’ `Extension ID`) вЂ” РѕРЅ РїСЂРёРіРѕРґРёС‚СЃСЏ РґР»СЏ РґРѕСЃС‚СѓРїР° Рє Р»РѕРіР°Рј.С‘

> Р•СЃР»Рё РїРѕСЃР»Рµ СЃР±РѕСЂРєРё РІ `dist/` РѕС‚СЃСѓС‚СЃС‚РІСѓСЋС‚ С„Р°Р№Р»С‹ РёР»Рё Chrome СЂСѓРіР°РµС‚СЃСЏ РЅР° `manifest.json`, СѓР±РµРґРёСЃСЊ, С‡С‚Рѕ РєРѕРјР°РЅРґР° `npm run build` Р·Р°РІРµСЂС€РёР»Р°СЃСЊ Р±РµР· РѕС€РёР±РѕРє.

## 4. Р“РґРµ СЃРјРѕС‚СЂРµС‚СЊ Р»РѕРіРё Рё СЃРѕСЃС‚РѕСЏРЅРёРµ

| Р§С‚Рѕ РїСЂРѕРІРµСЂСЏРµРј | РљР°Рє РѕС‚РєСЂС‹С‚СЊ | РќР° С‡С‚Рѕ СЃРјРѕС‚СЂРµС‚СЊ |
|---------------|-------------|-----------------|
| **Service Worker** (background) | `chrome://extensions/` в†’ **Details** в†’ **Inspect views: service worker** | РљРѕРЅСЃРѕР»СЊ РґРѕР»Р¶РЅР° РїРѕРєР°Р·С‹РІР°С‚СЊ Р»РѕРіРё СЃ РїСЂРµС„РёРєСЃРѕРј `codex-background`. РџСЂРё Р·Р°РіСЂСѓР·РєРµ РїРѕСЏРІСЏС‚СЃСЏ СЃРѕРѕР±С‰РµРЅРёСЏ `bootstrap content script`, `TASKS_UPDATE processed`, РїРµСЂРµРєР»СЋС‡РµРЅРёСЏ verbose-СЂРµР¶РёРјР°. РћС€РёР±РѕРє `Uncaught` Р±С‹С‚СЊ РЅРµ РґРѕР»Р¶РЅРѕ. |
| **Popup UI** | РљР»РёРє РїРѕ РёРєРѕРЅРєРµ СЂР°СЃС€РёСЂРµРЅРёСЏ в†’ Р·Р°С‚РµРј В«РџРѕРґСЂРѕР±РЅРµРµВ» в†’ **Inspect views: popup** | Р’Рѕ РІРєР»Р°РґРєРµ Elements/Console РїСЂРѕРІРµСЂСЊ, С‡С‚Рѕ DOM РѕС‚СЂРёСЃРѕРІР°РЅ, РЅРµС‚ РѕС€РёР±РѕРє `Failed to load popup state`. РўР°Р±Р»РёС†Р° Р·Р°РґР°С‡ РґРѕР»Р¶РЅР° СЃРѕРѕС‚РІРµС‚СЃС‚РІРѕРІР°С‚СЊ СЃРѕСЃС‚РѕСЏРЅРёСЋ РёР· background. |
| **Content script** | РћС‚РєСЂРѕР№ РІРєР»Р°РґРєСѓ `https://chatgpt.com` (РёР»Рё Р»СЋР±СѓСЋ `*.openai.com` / `*.chatgpt.com`) в†’ `Ctrl+Shift+I` в†’ Console | Р›РѕРіРё СЃ РїСЂРµС„РёРєСЃРѕРј `codex-content`. РџСЂРё РїРµСЂРІРѕРј Р·Р°РїСѓСЃРєРµ РґРѕР»Р¶РµРЅ РїРѕСЏРІРёС‚СЊСЃСЏ `bootstrap content script`. РћС€РёР±РєРё Рѕ РЅРµРґРѕСЃС‚СѓРїРЅС‹С… API РѕР·РЅР°С‡Р°СЋС‚ РїСЂРѕР±Р»РµРјС‹ СЃ СЂР°Р·СЂРµС€РµРЅРёСЏРјРё. |
| **Storage** | Р’ РєРѕРЅСЃРѕР»Рё service worker РІС‹РїРѕР»РЅРё `chrome.storage.session.get(null).then(console.log)` | РЈР±РµРґРёСЃСЊ, С‡С‚Рѕ РєР»СЋС‡ `codex.tasks.state` РїРѕСЏРІР»СЏРµС‚СЃСЏ РїРѕСЃР»Рµ РїРµСЂРІС‹С… СЃРѕР±С‹С‚РёР№. |

## 5. Р СѓС‡РЅРѕР№ СЃС†РµРЅР°СЂРёР№ РїСЂРѕРІРµСЂРєРё

1. **Р—Р°РїСѓСЃС‚Рё СЃР±РѕСЂРєСѓ** Рё Р·Р°РіСЂСѓР·РєСѓ СЂР°СЃС€РёСЂРµРЅРёСЏ (СЂР°Р·РґРµР»С‹ 2вЂ“3).
2. **РћС‚РєСЂРѕР№ РЅРѕРІСѓСЋ РІРєР»Р°РґРєСѓ** РЅР° `https://chatgpt.com/` (РёР»Рё Р°РєС‚СѓР°Р»СЊРЅС‹Р№ РґРѕРјРµРЅ Codex).
3. Р’ РєРѕРЅСЃРѕР»Рё РІРєР»Р°РґРєРё СѓР±РµРґРёСЃСЊ, С‡С‚Рѕ РЅРµС‚ РѕС€РёР±РѕРє РїСЂРё РёРЅРёС†РёР°Р»РёР·Р°С†РёРё content-script.
4. РЎС‹РјРёС‚РёСЂСѓР№ РїРѕСЏРІР»РµРЅРёРµ Р·Р°РґР°С‡ (РјРѕР¶РЅРѕ Р·Р°РїСѓСЃС‚РёС‚СЊ unit/contract С‚РµСЃС‚С‹ РёР»Рё РґРѕР¶РґР°С‚СЊСЃСЏ СЂРµР°Р»СЊРЅС‹С… СЃРѕР±С‹С‚РёР№). РџСЂРѕРІРµСЂСЏР№:
   - Р’ РєРѕРЅСЃРѕР»Рё service worker РїРѕСЏРІР»СЏСЋС‚СЃСЏ `TASKS_UPDATE processed` СЃ РєРѕСЂСЂРµРєС‚РЅС‹Рј `tabId` Рё `count`.
   - Р’ popup РѕС‚РѕР±СЂР°Р¶Р°РµС‚СЃСЏ РІРєР»Р°РґРєР° СЃ С‡РёСЃР»РѕРј Р°РєС‚РёРІРЅС‹С… Р·Р°РґР°С‡.
5. **РџСЂРѕРІРµСЂСЊ heartbeat**: СЃРїСѓСЃС‚СЏ ~45 СЃРµРєСѓРЅРґ РїСЂРѕСЃС‚РѕСЏ РІ Р»РѕРіР°С… РґРѕР»Р¶РЅР° РїРѕСЏРІРёС‚СЊСЃСЏ Р·Р°РїРёСЃСЊ Рѕ СЃС‚Р°С‚СѓСЃРµ `STALE`. Р’ popup РІРєР»Р°РґРєР° РїРѕР»СѓС‡РёС‚ РїСЂРµРґСѓРїСЂРµР¶РґРµРЅРёРµ `Connection lost`.
6. **РџРµСЂРµР·Р°РїСѓСЃС‚Рё РІРєР»Р°РґРєСѓ**: Р·Р°РєСЂРѕР№ С‚Р°Р±, СѓР±РµРґРёСЃСЊ, С‡С‚Рѕ РІ Р»РѕРіР°С… background РµСЃС‚СЊ `tab removal handling failed` **РЅРµС‚**. РЎС‚Р°С‚РёСЃС‚РёРєР° РґРѕР»Р¶РЅР° РѕР±РЅСѓР»РёС‚СЊСЃСЏ.
7. (РћРїС†РёРѕРЅР°Р»СЊРЅРѕ) **Р’РєР»СЋС‡Рё verbose-СЂРµР¶РёРј** РґР»СЏ РґРµС‚Р°Р»СЊРЅРѕР№ РґРёР°РіРЅРѕСЃС‚РёРєРё:
   ```js
   chrome.storage.session.set({ 'codex.tasks.verbose': true })
   ```
   - Р’С‹РїРѕР»РЅСЏРµС‚СЃСЏ РІ РєРѕРЅСЃРѕР»Рё service worker РёР»Рё popup. РџРѕСЃР»Рµ СѓСЃС‚Р°РЅРѕРІРєРё С„Р»Р°РіР° Р»РѕРіРё `codex-background`/`codex-content` СЃС‚Р°РЅСѓС‚ РїРѕРґСЂРѕР±РЅРµРµ.

## 6. Р§РµРє-Р»РёСЃС‚ РЅР° С‡С‚Рѕ РѕР±СЂР°С‚РёС‚СЊ РІРЅРёРјР°РЅРёРµ

- [ ] Р’ `chrome://extensions/` РЅРµС‚ РїСЂРµРґСѓРїСЂРµР¶РґРµРЅРёР№ РїРѕ СЂР°Р·СЂРµС€РµРЅРёСЏРј Рё РѕС€РёР±РѕРє Р·Р°РіСЂСѓР·РєРё.
- [ ] Service worker Р°РєС‚РёРІРµРЅ (РІ РєР°СЂС‚РѕС‡РєРµ СЂР°СЃС€РёСЂРµРЅРёСЏ СЃС‚Р°С‚СѓСЃ `Service worker (Running)` РёР»Рё `Stopped` СЃ РІРѕР·РјРѕР¶РЅРѕСЃС‚СЊСЋ РІСЂСѓС‡РЅСѓСЋ Р·Р°РїСѓСЃС‚РёС‚СЊ). Р•СЃР»Рё РѕРЅ РїР°РґР°РµС‚ вЂ” РєРѕРїРёСЂСѓР№ СЃС‚РµРє.
- [ ] Content script СЂРµР°Р»СЊРЅРѕ РїРѕРґРєР»СЋС‡Р°РµС‚СЃСЏ РЅР° СЃС‚СЂР°РЅРёС†Р°С… `*.openai.com` / `*.chatgpt.com` (Р»РѕРі `bootstrap content script`).
- [ ] Popup РѕС‚РєСЂС‹РІР°РµС‚СЃСЏ Р±РµР· РєСЂР°СЃРЅС‹С… РѕС€РёР±РѕРє РІ РєРѕРЅСЃРѕР»Рё, Р»РѕРєР°Р»РёР·Р°С†РёСЏ РїРѕРґСЃС‚Р°РІР»СЏРµС‚ С‚РµРєСѓС‰РµРµ Р·РЅР°С‡РµРЅРёРµ `state.locale`.
- [ ] РЎРѕСЃС‚РѕСЏРЅРёРµ РІ popup СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓРµС‚ Р»РѕРіР°Рј `TASKS_UPDATE` (С‡РёСЃР»Рѕ Р·Р°РґР°С‡, С‚Р°Р№РјСЃС‚РµРјРїС‹ РѕР±РЅРѕРІР»РµРЅРёР№, СЃС‚Р°С‚СѓСЃ heartbeat).
- [ ] РџСЂРё РІРєР»СЋС‡РµРЅРёРё verbose-СЂРµР¶РёРјР° РїРѕСЏРІР»СЏСЋС‚СЃСЏ СЃРѕРѕР±С‰РµРЅРёСЏ `verbose flag toggled`.
- [ ] РџРѕСЃР»Рµ РѕС‚РєР»СЋС‡РµРЅРёСЏ РёР»Рё СѓРґР°Р»РµРЅРёСЏ СЂР°СЃС€РёСЂРµРЅРёСЏ (`Remove`) С„РѕРЅРѕРІС‹Р№ СЃРµСЂРІРёСЃ worker РєРѕСЂСЂРµРєС‚РЅРѕ Р·Р°РІРµСЂС€Р°РµС‚СЃСЏ (РЅРµС‚ Р±РµСЃРєРѕРЅРµС‡РЅС‹С… РѕС€РёР±РѕРє РїСЂРё unload).

## 7. РљР°Рє РѕР±РЅРѕРІР»СЏС‚СЊ СЂР°СЃС€РёСЂРµРЅРёРµ РїСЂРё РЅРѕРІС‹С… СЃР±РѕСЂРєР°С…

1. РћСЃС‚Р°РЅРѕРІРё `npm run dev` (РµСЃР»Рё Р·Р°РїСѓС‰РµРЅ) Рё РІС‹РїРѕР»РЅРёС‚Рµ РЅРѕРІСѓСЋ `npm run build`.
2. Р’ `chrome://extensions/` РЅР°Р¶РјРё РєРЅРѕРїРєСѓ **Reload** РЅР° РєР°СЂС‚РѕС‡РєРµ СЂР°СЃС€РёСЂРµРЅРёСЏ.
3. РџСЂРѕРІРµСЂСЊ, С‡С‚Рѕ РґР°С‚Р° РѕР±РЅРѕРІР»РµРЅРёСЏ (`Installed`) РёР·РјРµРЅРёР»Р°СЃСЊ Рё Р»РѕРіРё СЃРµСЂРІРёСЃ-РІРѕСЂРєРµСЂР° РїРµСЂРµР·Р°РїСѓСЃС‚РёР»РёСЃСЊ.
4. РџРѕРІС‚РѕСЂРё С‡РµРє-Р»РёСЃС‚ РёР· СЂР°Р·РґРµР»Р° 6.

Р•СЃР»Рё С‡С‚Рѕ-С‚Рѕ РёРґС‘С‚ РЅРµ С‚Р°Рє вЂ” СЃРѕР±РµСЂРё РІСЃСЋ РєРѕРЅСЃРѕР»СЊ (service worker, popup, content script) Рё РѕС‚РїСЂР°РІСЊ РјРЅРµ РІРјРµСЃС‚Рµ СЃ РѕРїРёСЃР°РЅРёРµРј РґРµР№СЃС‚РІРёР№. РўР°Рє РјС‹ СЃРјРѕР¶РµРј Р±С‹СЃС‚СЂРµРµ Р»РѕРєР°Р»РёР·РѕРІР°С‚СЊ РїСЂРѕР±Р»РµРјСѓ.
### Звуковое уведомление
- После активации всплывающего окна расширение разблокирует Web Audio API и воспроизводит короткий сигнал при завершении всех задач (верхний счётчик переходит из >0 в 0).
- Если звук не воспроизводится, нажмите на иконку и снова откройте popup для повторной активации AudioContext.
