# Запуск и ручная проверка Chrome-расширения Codex Tasks Watcher

> Этот документ дополняет руководство по Фазе 5 и объясняет, как собрать проект, загрузить расширение в браузер и что проверять при ручном тестировании. Все шаги относятся к сборке Manifest V3, которая лежит в каталоге `extension/`.

## 1. Что понадобится

- **Браузер**: Google Chrome 120+ или Chromium-совместимый браузер (Manifest V3 поддерживается по умолчанию).
- **Node.js**: версия 18 или 20 (совместимая с Vite и MV3-плагином).
- **npm**: поставляется вместе с Node.js.

## 2. Подготовка сборки

1. Выполни установку зависимостей (если не делал этого ранее):
   ```bash
   npm install
   ```
2. Собери расширение:
   ```bash
   npm run build
   ```
   - Vite соберёт исходники из `extension/src/**` и положит готовый пакет в каталог `dist/`.
   - Перед каждой новой сборкой Vite очищает `dist/`, поэтому не держи там ручных файлов.
3. (Опционально) Для быстрой итерации можно запустить режим слежения:
   ```bash
   npm run dev
   ```
   - Команда запускает `vite build --watch`, автоматически пересобирающий `dist/` при изменениях исходников.
   - После пересборки всё равно нужно вручную «обновить» расширение в браузере.

## 3. Загрузка расширения в Chrome

1. Открой `chrome://extensions/`.
2. Включи **Developer mode** (правый верхний угол).
3. Нажми **Load unpacked** → выбери папку `dist/` внутри репозитория.
4. Проверь, что в карточке расширения нет ошибок:
   - Статус должен быть `This extension is enabled`.
   - Кнопка «Errors» должна отсутствовать. Если появляется — открой и скопируй стек-трейс.
5. Запомни идентификатор расширения (кнопка **Details** → `Extension ID`) — он пригодится для доступа к логам.

> Если после сборки в `dist/` отсутствуют файлы или Chrome ругается на `manifest.json`, убедись, что команда `npm run build` завершилась без ошибок.

## 4. Где смотреть логи и состояние

| Что проверяем | Как открыть | На что смотреть |
|---------------|-------------|-----------------|
| **Service Worker** (background) | `chrome://extensions/` → **Details** → **Inspect views: service worker** | Консоль должна показывать логи с префиксом `codex-background`. При загрузке появятся сообщения `bootstrap content script`, `TASKS_UPDATE processed`, переключения verbose-режима. Ошибок `Uncaught` быть не должно. |
| **Popup UI** | Клик по иконке расширения → затем «Подробнее» → **Inspect views: popup** | Во вкладке Elements/Console проверь, что DOM отрисован, нет ошибок `Failed to load popup state`. Таблица задач должна соответствовать состоянию из background. |
| **Content script** | Открой вкладку `https://chatgpt.com` (или любую `*.openai.com` / `*.chatgpt.com`) → `Ctrl+Shift+I` → Console | Логи с префиксом `codex-content`. При первом запуске должен появиться `bootstrap content script`. Ошибки о недоступных API означают проблемы с разрешениями. |
| **Storage** | В консоли service worker выполни `chrome.storage.session.get(null).then(console.log)` | Убедись, что ключ `codex.tasks.state` появляется после первых событий. |

## 5. Ручной сценарий проверки

1. **Запусти сборку** и загрузку расширения (разделы 2–3).
2. **Открой новую вкладку** на `https://chatgpt.com/` (или актуальный домен Codex).
3. В консоли вкладки убедись, что нет ошибок при инициализации content-script.
4. Сымитируй появление задач (можно запустить unit/contract тесты или дождаться реальных событий). Проверяй:
   - В консоли service worker появляются `TASKS_UPDATE processed` с корректным `tabId` и `count`.
   - В popup отображается вкладка с числом активных задач.
5. **Проверь heartbeat**: спустя ~45 секунд простоя в логах должна появиться запись о статусе `STALE`. В popup вкладка получит предупреждение `Connection lost`.
6. **Перезапусти вкладку**: закрой таб, убедись, что в логах background есть `tab removal handling failed` **нет**. Статистика должна обнулиться.
7. (Опционально) **Включи verbose-режим** для детальной диагностики:
   ```js
   chrome.storage.session.set({ 'codex.tasks.verbose': true })
   ```
   - Выполняется в консоли service worker или popup. После установки флага логи `codex-background`/`codex-content` станут подробнее.

## 6. Чек-лист на что обратить внимание

- [ ] В `chrome://extensions/` нет предупреждений по разрешениям и ошибок загрузки.
- [ ] Service worker активен (в карточке расширения статус `Service worker (Running)` или `Stopped` с возможностью вручную запустить). Если он падает — копируй стек.
- [ ] Content script реально подключается на страницах `*.openai.com` / `*.chatgpt.com` (лог `bootstrap content script`).
- [ ] Popup открывается без красных ошибок в консоли, локализация подставляет текущее значение `state.locale`.
- [ ] Состояние в popup соответствует логам `TASKS_UPDATE` (число задач, таймстемпы обновлений, статус heartbeat).
- [ ] При включении verbose-режима появляются сообщения `verbose flag toggled`.
- [ ] После отключения или удаления расширения (`Remove`) фоновый сервис worker корректно завершается (нет бесконечных ошибок при unload).

## 7. Как обновлять расширение при новых сборках

1. Останови `npm run dev` (если запущен) и выполните новую `npm run build`.
2. В `chrome://extensions/` нажми кнопку **Reload** на карточке расширения.
3. Проверь, что дата обновления (`Installed`) изменилась и логи сервис-воркера перезапустились.
4. Повтори чек-лист из раздела 6.

Если что-то идёт не так — собери всю консоль (service worker, popup, content script) и отправь мне вместе с описанием действий. Так мы сможем быстрее локализовать проблему.
