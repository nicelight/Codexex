# Руководство по Фазе 5: Тестирование и контроль качества

> Этот документ создан для того, чтобы быстро ввести тебя в процесс тестирования перед началом Фазы 5 из [roadmap](../spec/roadmap.md). Он описывает роли, ключевые термины и пошаговые сценарии запуска тестов. Предполагается, что я (агент) готовлю инфраструктуру и тестовые кейсы, а ты запускаешь и проверяешь результаты.

## 1. Что входит в Фазу 5

| Подзадача | Что должно быть готово с моей стороны | Что делаешь ты |
|-----------|----------------------------------------|----------------|
| **Unit tests** | Файлы в `extension/tests/unit`, общие Chrome-моки (`extension/src/shared/chrome.ts`), DOM-фикстуры и тестовые данные. Команда `npm run test:unit`. | Запускаешь тесты, читаешь отчёт Vitest, сообщаешь о фейлах или странных логах.
| **Contract tests** | Проверки JSON Schema и OpenAPI (`extension/tests/contract/contracts.test.ts`), автозапуск локального HTTP-адаптера. Команда `npm run test:contract`. | Запускаешь проверки, удостоверяешься, что все DTO/ручки проходят схемы, фиксируешь несоответствия.
| **Локальный HTTP-адаптер** | Реализован в `extension/tests/support/http-adapter.ts`, используется контрактными тестами автоматически. | Дополнительно вручную запускать не требуется: тесты поднимают/останавливают сервер сами.
| **Integration tests** | Сценарии UC-1 / UC-2 (`extension/tests/integration/use-cases.test.ts`) с фейковым DOM, таймерами и связкой content ↔ background. Команда `npm run test:integration`. | Запускаешь сценарии целиком, анализируешь поведение (pass/fail), смотришь логи для подтверждения heartbeat/verbose-флага.

## 2. Словарь терминов

| Термин | Определение |
|--------|-------------|
| **Unit test** | Автотест, проверяющий отдельную функцию или модуль в изоляции от остальных частей системы. Для фронтенда часто использует jsdom и моки API.
| **Contract test** | Проверка соответствия между кодом и формальными контрактами (JSON Schema, OpenAPI). Гарантирует, что отправляемые/принимаемые данные соответствуют утверждённым спецификациям.
| **Integration test** | Тест, который соединяет несколько модулей и проверяет их совместную работу по сценариям из use-case. В нашем проекте эмулирует работу контент-скрипта, background worker и popup.
| **Mock** | Заменитель реальной зависимости (например, Chrome API), чтобы тесты работали предсказуемо.
| **Fixture** | Подготовленный набор данных или DOM-фрагмент для повторного использования в тестах.
| **Heartbeat** | Периодический сигнал от content-script для подтверждения активности вкладки (см. `contracts/dto/content-heartbeat.schema.json`).
| **Verbose-логирование** | Расширенный режим логов, который включается флагом в `chrome.storage.session` и должен переключаться тестами.
| **Vitest** | Инструмент запуска тестов (аналог Jest), уже прописан в `package.json`.
| **CI (Continuous Integration)** | Автоматизированный запуск тестов при каждом коммите/PR. Локально ты повторяешь те же команды, что будут выполняться в CI.

## 3. Подготовка окружения

1. **Установи Node.js версии 18 или 20** (совместимо с Vite и Vitest).
2. В корне проекта выполни:
   ```bash
   npm install
   ```
   Это подтянет все зависимости, включая Vitest и ajv.
3. Если зависимости уже стоят, перед запуском тестов можно обновить локальную копию кода:
   ```bash
   git pull
   ```
4. Все команды тестов запускаются из корня репозитория `/workspace/Codexex`.

## 4. Workflow по типам тестов

### 4.1 Unit tests

1. Убедись, что выполнены шаги из раздела «Подготовка окружения».
2. Запусти команду:
   ```bash
   npm run test:unit
   ```
3. В выводе Vitest обрати внимание на:
   - `Passed` / `Failed` суммарно.
   - Список тестовых файлов, если есть ошибки (Vitest покажет трассировки).
4. При фейлах:
   - Скопируй сообщение об ошибке и отправь мне.
   - Если ошибка связана с DOM/фикстурой, приложи фрагмент лога.
5. По желанию можно перейти в watch-режим для повторного прогона при изменениях:
   ```bash
   npx vitest watch --dir extension/tests/unit
   ```

### 4.2 Contract tests

1. После подготовки окружения выполни:
   ```bash
   npm run test:contract
   ```
2. Vitest автоматически поднимет мини-сервер (см. `extension/tests/support/http-adapter.ts`) и проверит:
   - JSON Schema (`contracts/dto/*.schema.json`, `contracts/state/aggregated-state.schema.json`) через `ajv`;
   - OpenAPI `contracts/openapi.yaml` — ответы `/background/state` и `/popup/state` сверяются с актуальными данными агрегатора;
   - RU/EN локализация уведомлений (контрактный тест проверяет сообщение «Наблюдатель задач Codex» при `ru-RU`).
   - обработку ошибок: некорректный `TASKS_UPDATE` должен вернуть `400` с массивом `errors`.
3. Если упала проверка, смотри вывод из `extension/tests/contract/contracts.test.ts` — там печатаются пути до схем и сообщения `ajv`.

### 4.3 Локальный HTTP-адаптер

Mock-сервер реализован в `extension/tests/support/http-adapter.ts` и поднимается автоматически в контрактных тестах.

- Поддерживаемые ручки: `POST /background/tasks-update`, `POST /background/tasks-heartbeat`, `GET /background/state`, `GET /popup/state`.
- Данные прокидываются напрямую в агрегатор, так что ручной запуск/переключение сценариев не требуется.
- Если нужно протестировать ручку вручную, загляни в реализацию `startTestHttpAdapter` — там видно, какие payload'ы ожидаются и какой ответ возвращается.

### 4.4 Integration tests

1. Запусти:
   ```bash
   npm run test:integration
   ```
2. Сейчас покрыты два ключевых сценария из [`spec/use-cases.md`](../spec/use-cases.md):
   - **UC-1 / AC1-AC2** — антидребезг и одиночное уведомление, когда все задачи закрыты.
   - **UC-2 / AC8** — потеря heartbeat, срабатывание `chrome.alarms` и восстановление по `PING`.
   При необходимости добавляй новые истории прямо в `extension/tests/integration/use-cases.test.ts`.
3. Следи за выводом Vitest: там видны промежуточные шаги (например, переход heartbeat в `STALE`). Если что-то ломается, приложи лог и номер сценария.

## 5. Как мы будем взаимодействовать

1. **Я** обеспечиваю готовность тестов и обновляю документацию по мере реализации (например, добавлю точные команды для mock-сервера).
2. **Ты** следуешь workflow из этого документа, запускаешь команды и сообщаешь о результатах.
3. Если нужно уточнить термин или шаг, ориентируемся на этот документ и разделы `spec/test-plan.md`, `spec/nfr.md`, `spec/roadmap.md`.
4. Все новые инструкции или изменения я буду добавлять сюда, чтобы у тебя всегда была актуальная шпаргалка.

## 6. Полезные ссылки по репозиторию

- [Roadmap (Фаза 5)](../spec/roadmap.md)
- [Тест-план](../spec/test-plan.md)
- [NFR и требования к качеству](../spec/nfr.md)
- [Описание use-case](../spec/use-cases.md)
- [Контрактные тесты и HTTP-адаптер](../extension/tests/contract/contracts.test.ts)
- [Интеграционные сценарии](../extension/tests/integration/use-cases.test.ts)
- [Запуск расширения в браузере](./phase-5-browser-manual.md)

Если у тебя появятся вопросы по конкретным командам или результатам тестов — пиши, и мы обновим документ.
