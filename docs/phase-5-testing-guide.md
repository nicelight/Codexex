# Руководство по Фазе 5: Тестирование и контроль качества

> Этот документ создан для того, чтобы быстро ввести тебя в процесс тестирования перед началом Фазы 5 из [roadmap](../spec/roadmap.md). Он описывает роли, ключевые термины и пошаговые сценарии запуска тестов. Предполагается, что я (агент) готовлю инфраструктуру и тестовые кейсы, а ты запускаешь и проверяешь результаты.

## 1. Что входит в Фазу 5

| Подзадача | Что должно быть готово с моей стороны | Что делаешь ты |
|-----------|----------------------------------------|----------------|
| **Unit tests** | Общие моки Chrome API, фикстуры DOM, тестовые данные, команды `npm run test:unit`. | Запускаешь тесты, читаешь отчёт Vitest, сообщаешь о фейлах или странных логах.
| **Contract tests** | Скрипты валидации JSON Schema/OpenAPI, команда `npm run test:contract`, документация по ожидаемым контрактам. | Запускаешь проверки, удостоверяешься, что все DTO/ручки проходят схемы, фиксируешь несоответствия.
| **Локальный HTTP-адаптер** | Имитация backend эндпоинтов (MSW или аналог), заскриптованные сценарии. | При необходимости поднимаешь адаптер, проверяешь, что тесты его видят, повторяешь команды из инструкции.
| **Integration tests** | Комплексные сценарии (UC-1..UC-3), фейковый DOM/таймеры, команда `npm run test:integration`. | Запускаешь сценарии целиком, анализируешь поведение (pass/fail), смотришь логи для подтверждения heartbeat/verbose-флага.

## 2. Словарь терминов

| Термин | Определение |
|--------|-------------|
| **Unit test** | Автотест, проверяющий отдельную функцию или модуль в изоляции от остальных частей системы. Для фронтенда часто использует jsdom и моки API.
| **Contract test** | Проверка соответствия между кодом и формальными контрактами (JSON Schema, OpenAPI). Гарантирует, что отправляемые/принимаемые данные соответствуют утверждённым спецификациям.
| **Integration test** | Тест, который соединяет несколько модулей и проверяет их совместную работу по сценариям из use-case. В нашем проекте эмулирует работу контент-скрипта, background worker и popup.
| **Mock** | Заменитель реальной зависимости (например, Chrome API), чтобы тесты работали предсказуемо.
| **Fixture** | Подготовленный набор данных или DOM-фрагмент для повторного использования в тестах.
| **Heartbeat** | Периодический сигнал от content-script для подтверждения активности вкладки (см. `contracts/dto/content-heartbeat.schema.json`).
| **Verbose-логирование** | Расширенный режим логов, который включается флагом в `chrome.storage.session` и должен переключаться тестами.
| **Vitest** | Инструмент запуска тестов (аналог Jest), уже прописан в `package.json`.
| **CI (Continuous Integration)** | Автоматизированный запуск тестов при каждом коммите/PR. Локально ты повторяешь те же команды, что будут выполняться в CI.

## 3. Подготовка окружения

1. **Установи Node.js версии 18 или 20** (совместимо с Vite и Vitest).
2. В корне проекта выполни:
   ```bash
   npm install
   ```
   Это подтянет все зависимости, включая Vitest и ajv.
3. Если зависимости уже стоят, перед запуском тестов можно обновить локальную копию кода:
   ```bash
   git pull
   ```
4. Все команды тестов запускаются из корня репозитория `/workspace/Codexex`.

## 4. Workflow по типам тестов

### 4.1 Unit tests

1. Убедись, что выполнены шаги из раздела «Подготовка окружения».
2. Запусти команду:
   ```bash
   npm run test:unit
   ```
3. В выводе Vitest обрати внимание на:
   - `Passed` / `Failed` суммарно.
   - Список тестовых файлов, если есть ошибки (Vitest покажет трассировки).
4. При фейлах:
   - Скопируй сообщение об ошибке и отправь мне.
   - Если ошибка связана с DOM/фикстурой, приложи фрагмент лога.
5. По желанию можно перейти в watch-режим для повторного прогона при изменениях:
   ```bash
   npx vitest watch --dir extension/tests/unit
   ```

### 4.2 Contract tests

1. После подготовки окружения выполни:
   ```bash
   npm run test:contract
   ```
2. Vitest запустит проверки, которые используют `ajv` для JSON Schema и валидаторы OpenAPI.
3. В случае ошибок:
   - Посмотри, какой именно контракт не совпал (Vitest покажет путь к схеме и нарушенное поле).
   - Сообщи мне, чтобы я проверил соответствие схемы и реализации.
4. Если нужно валидировать конкретный DTO локально, можно воспользоваться Node-скриптом (будет предоставлен мной) или командой вроде:
   ```bash
   npx ts-node scripts/validate-dto.ts path/to/payload.json
   ```
   (конкретная утилита появится в рамках реализации Фазы 5).

### 4.3 Локальный HTTP-адаптер

1. После того как я добавлю mock-сервер (например, на базе `msw`), появится npm-скрипт, условно:
   ```bash
   npm run test:server
   ```
2. Workflow:
   - Запусти сервер в отдельном терминале.
   - Убедись, что он слушает нужные ручки (`/background/tasks-update`, `/background/tasks-heartbeat`, `/background/state`, `/popup/state`).
   - Выполни соответствующий тестовый набор (unit/contract/integration) — они будут стучаться в мок вместо реального backend.
   - После завершения останови сервер `Ctrl+C`.
3. В документации к мок-серверу будет список предустановленных сценариев. Если тесты просят переключить сценарий (например, симулировать `heartbeat` с задержкой), выполни команду вида:
   ```bash
   curl -X POST http://localhost:4000/scenario -d '{"name":"lost-heartbeat"}'
   ```
   (конкретные команды будут задокументированы рядом с реализацией сервера).

### 4.4 Integration tests

1. Запусти:
   ```bash
   npm run test:integration
   ```
2. Эти тесты выполняют сценарии UC-1..UC-3 из [`spec/use-cases.md`](../spec/use-cases.md) и проверяют, что:
   - Content-script правильно детектирует задачи и отправляет `TASKS_UPDATE`.
   - Background агрегирует состояние, отправляет уведомления и heartbeat.
   - Popup отображает состояние для пользователя.
3. Следи за логами:
   - Будут упоминания `heartbeat`, `verbose` и `autoDiscardableOff`. Если что-то выглядит странно (например, heartbeat не переходит в `STALE`), зафиксируй это.
4. При проблемах — приложи лог и номер сценария (UC-1, UC-2 или UC-3).

## 5. Как мы будем взаимодействовать

1. **Я** обеспечиваю готовность тестов и обновляю документацию по мере реализации (например, добавлю точные команды для mock-сервера).
2. **Ты** следуешь workflow из этого документа, запускаешь команды и сообщаешь о результатах.
3. Если нужно уточнить термин или шаг, ориентируемся на этот документ и разделы `spec/test-plan.md`, `spec/nfr.md`, `spec/roadmap.md`.
4. Все новые инструкции или изменения я буду добавлять сюда, чтобы у тебя всегда была актуальная шпаргалка.

## 6. Полезные ссылки по репозиторию

- [Roadmap (Фаза 5)](../spec/roadmap.md)
- [Тест-план](../spec/test-plan.md)
- [NFR и требования к качеству](../spec/nfr.md)
- [Описание use-case](../spec/use-cases.md)
- [Запуск расширения в браузере](./phase-5-browser-manual.md)


Если у тебя появятся вопросы по конкретным командам или результатам тестов — пиши, и мы обновим документ.
