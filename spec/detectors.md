# Detectors & Signals — Codex Tasks Watcher

| ID | Назначение | DOM-сигнатуры / источники | Надёжность | Частота опроса | Антидребезг / фильтры | Примечания |
|----|------------|---------------------------|------------|----------------|-----------------------|------------|
| D1_SPINNER | Фиксирует глобальные индикаторы загрузки и анимации прогресса в Codex. | `[aria-busy="true"]`, элементы с `role="progressbar"`, SVG с `animateTransform`, элементы с классами `animate-spin`, `loading-spinner`. | Высокая: присутствует при активном выполнении задачи. | Непрерывный `MutationObserver`; периодический snapshot не чаще 1 раз/сек. | Требует подтверждения исчезновения в течение 500 мс перед отправкой `count=0`. | Работает в RU/EN интерфейсе; учитывать вложенные iframes. |
| D2_STOP_BUTTON | Определяет активные задачи по наличию кнопок «Stop/Остановить» в списке задач. | Кнопки/ссылки с текстом `Stop`, `Остановить`, `Stop run`, элементы с `data-testid="codex-stop"`. | Средняя: зависит от локализации текста, но отображается пока задача активна. | Те же события MutationObserver; fallback сканирование раз в 1 сек. | Статусы кэшируются по taskId, чтобы предотвращать мерцания при обновлении списка. | Используется для подсчёта количества задач (`count`). |
| D3_CARD_HEUR | Эвристика по карточкам задач: анализ заголовков, статусов «Running», индикаторов времени. | Элементы списка задач с текстами `Running`, `Выполняется`, наличие таймера обратного отсчёта. | Низкая: использовать только как резерв, если D1/D2 не дают сигнал. | Запускать по запросу (когда D1/D2 не обнаружили активность, но пользователь ожидает статус). | Результаты помечаются как `confidence=low` в `signals`. | Планируется к активации в v0.2.0+, требует дополнительного обучения. |

## Архитектура детекторов
- Контент-скрипт регистрирует `MutationObserver` на `document.documentElement` и объединяет события в батчи.
- Для каждого батча запускается пайплайн детекторов в порядке приоритета: D1 → D2 → D3 (по мере необходимости).
- Вычисляется `count` как максимум между уникальными задачами, найденными D2/D3, и числовыми индикаторами D1.
- Каждая запись `signals` содержит `{ detector, evidence, taskKey?, confidence? }`.

## Стратегии устойчивости
- Локализация: текстовые детекторы используют набор ключевых слов на RU/EN; планируется вынести в конфиг для обновления без релиза.
- Изменение DOM: селекторы определены максимально общими (через роли/атрибуты). При критических изменениях обновление выполняется через release.
- Защита от ложных срабатываний: комбинация нескольких сигналов (например, наличие спиннера и кнопки Stop) повышает уверенность.

## Приоритеты и комбинирование сигналов
- `active` = `true`, если любой детектор сообщает активность.
- `count` определяется по следующему правилу: `max(D2_count, D3_count, D1_indicatorCount)`.
- При одновременном обнаружении D1 и D2 сигнал фиксируется как high confidence.
- Если только D3 → помечается низкая уверенность; background может оповещать с дополнительной задержкой (расширение v0.2.0+).

## Антидребезг сигналов
- Контент-скрипт задерживает отправку `TASKS_UPDATE` с `count=0` на 500 мс, чтобы фильтровать короткие мерцания.
- Background применяет глобальный антидребезг 12–15 секунд перед уведомлением.
- Для D1 запрещено отправлять `count>0` чаще, чем раз в 250 мс, чтобы избежать перегрузки воркера.
