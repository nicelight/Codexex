# Detectors & Signals — Codex Tasks Watcher

| ID | Назначение | DOM-сигнатуры / источники | Надёжность | Частота опроса | Антидребезг / фильтры | Примечания |
|----|------------|---------------------------|------------|----------------|-----------------------|------------|
| D1_SPINNER | Фиксирует глобальные индикаторы загрузки и анимации прогресса в Codex. | `[aria-busy="true"]`, элементы с `role="progressbar"`, SVG с `animateTransform`, элементы с классами `animate-spin`, `loading-spinner`. Факт‑чек скриншотов показывает, что в списке задач используется вложенный `span.flex.h-4.w-4.items-center.justify-center > svg.animate-spin` внутри `button[data-testid="codex-stop"]`. | Высокая: присутствует при активном выполнении задачи. | Непрерывный `MutationObserver`; периодический snapshot не чаще 1 раз/сек. | Требует подтверждения исчезновения в течение 500 мс перед отправкой `count=0`. | Работает в RU/EN интерфейсе; учитывать вложенные iframes. |
| D2_STOP_BUTTON | Определяет активные задачи по наличию кнопок «Stop/Cancel/Остановить/Отменить» в списке задач. | Кнопки/ссылки с текстом `Stop`, `Stop run`, `Cancel task`, `Остановить`, `Отменить задачу`, элементы с `data-testid="codex-stop"` или `aria-label*="cancel"`. На внутренних страницах задачи подтверждено наличие `button[data-testid="codex-stop"]` с вложенным `span[aria-hidden="true"]` и текстовым `span` с локализованной надписью. | Средняя: зависит от локализации текста, но отображается пока задача активна. | Те же события MutationObserver; fallback сканирование раз в 1 сек. | Статусы кэшируются по taskId, чтобы предотвращать мерцания при обновлении списка. | Используется для подсчёта количества задач (`count`). |
| D3_CARD_HEUR | Эвристика по карточкам задач: анализ заголовков, статусов «Running», индикаторов времени. | Элементы списка задач с текстами `Running`, `Выполняется`, наличие таймера обратного отсчёта. | Низкая: активируется в релизах v0.2.0+ как резерв, если D1/D2 не дают сигнал. | Запускать по запросу (когда D1/D2 не обнаружили активность, но пользователь ожидает статус). | При активации даёт полноценные `signals` и `count` наравне с D2, но помечается как низконадёжный источник. | Требует дополнительного обучения, rollout возможен поэтапно в v0.2.0+. |
| D4_TASK_COUNTER | Считывает числовой индикатор активных задач на странице просмотра конкретной задачи. | `div.absolute.inset-0.flex.items-center.justify-center > span` с числовым значением внутри индикатора в правом верхнем углу. | Высокая: отображает счётчик самой платформы Codex. | Непрерывный `MutationObserver`; часть общего пайплайна. | Значение нормализуется до целого, берётся максимум по всем найденным индикаторам. | Используется как источник глобального счётчика при отсутствии вкладок со списком задач. |

## Архитектура детекторов
- Контент-скрипт регистрирует `MutationObserver` на `document.documentElement` и объединяет события в батчи.
- Для каждого батча запускается пайплайн детекторов в порядке приоритета: D4 → D1 → D2 → D3 (по мере необходимости).
- Вычисляется `count` как максимум между уникальными задачами, найденными D2/D3, и числовыми индикаторами D1.
- Каждая запись `signals` содержит `{ detector, evidence, taskKey? }`.

## Стратегии устойчивости
- Локализация: текстовые детекторы используют набор ключевых слов на RU/EN; планируется вынести в конфиг для обновления без релиза.
- Изменение DOM: селекторы определены максимально общими (через роли/атрибуты). При критических изменениях обновление выполняется через release.
- Защита от ложных срабатываний: комбинация нескольких сигналов (например, наличие спиннера и кнопки Stop) повышает уверенность.
- Контент-скрипт поддерживает heartbeat: после каждого полного сканирования фиксируется `lastScanAt`, и независимо от наличия новых сигналов каждые ≤15 секунд отправляется `TASKS_HEARTBEAT`. Если alarm `PING` застал вкладку без свежего heartbeat, выполняется немедленное сканирование перед ответом.

## Приоритеты и комбинирование сигналов
- `active` = `true`, если любой детектор сообщает активность.
- `count` определяется по следующему правилу: `max(D4_counter, D2_count, D3_count, D1_indicatorCount)`; начиная с v0.2.0+ D3 участвует в расчёте наравне с D2, когда детектор активирован.
- При одновременном обнаружении D1 и D2 сигнал считается наиболее надёжным.
- Если только D3 → сигнал интерпретируется как низконадёжный (но всё равно повышает `count`); background может оповещать с дополнительной задержкой в релизах v0.2.0+.

## Антидребезг сигналов и heartbeat
- Контент-скрипт задерживает отправку `TASKS_UPDATE` с `count=0` на 500 мс, чтобы фильтровать короткие мерцания.
- Background применяет глобальный антидребезг 12–15 секунд перед уведомлением.
- Для D1 запрещено отправлять `count>0` чаще, чем раз в 250 мс, чтобы избежать перегрузки воркера.
- Heartbeat (`TASKS_HEARTBEAT`) отправляется без дополнительного антидребезга и не зависит от активности детекторов; background использует его только для обновления `lastSeenAt` и статуса вкладки.
