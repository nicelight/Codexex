# Detectors & Signals — Codex Tasks Watcher

| ID | Назначение | DOM-сигнатуры / источники | Надёжность | Частота опроса | Антидребезг / фильтры | Примечания |
|----|------------|---------------------------|------------|----------------|-----------------------|------------|
| D1_SPINNER | Фиксирует глобальные индикаторы загрузки и анимации прогресса в Codex. | `[aria-busy="true"]`, элементы с `role="progressbar"`, SVG с `animateTransform`, классы `.animate-spin`, `.loading-spinner`. ActivityScanner ограничивается первыми 5 совпадениями, чтобы не раздувать сообщение. | Высокая: присутствует при активном выполнении задачи. | Непрерывный `MutationObserver`; при тишине выполняется запасное сканирование не чаще 1 раз/сек. | Общий debounce 500 мс перед отправкой `count=0`. | Работает в RU/EN интерфейсе; селекторы подобраны максимально общими. |
| D2_STOP_BUTTON | Определяет активные задачи по наличию кнопок «Stop/Cancel/Остановить/Отменить» в списке задач. | `button`, `[role="button"]`, `a[href]` с текстом/атрибутами `Stop`, `Cancel`, `Остановить`, `Отменить`, а также `title`, `aria-label`, `data-testid`. | Средняя: зависит от локализации текста, но кнопка присутствует пока задача активна. | Те же события `MutationObserver`; fallback-сканирование не чаще 1 раз/сек. | Игнорируются скрытые (`hidden`, `aria-hidden`, `display:none`, `opacity:0`) и отключённые (`disabled`, `aria-disabled=true`) элементы. | `taskKey` извлекается из ближайших `data-task-id`/`data-id`/`data-reactid`, если доступны. |
| D3_CARD_HEUR | Эвристика по карточкам задач: анализ заголовков, статусов «Running», индикаторов времени. | Элементы списка задач с текстами `Running`, `Выполняется`, наличие таймера обратного отсчёта. | Низкая: резервный путь для релизов v0.2.0+. | Отключена в v0.1.0; запуск возможен только после отдельного согласования, если базовые эвристики не справляются. | При включении даёт сигналы наравне с D2, но помечается как низконадёжный источник. | Требует отдельной проверки и тестов перед rollout. |
| D4_TASK_COUNTER | Считывает числовой индикатор активных задач на странице просмотра конкретной задачи. | `div.absolute.inset-0.flex.items-center.justify-center` с числовым текстом внутри. | Высокая: отображает счётчик самой платформы Codex. | Непрерывный `MutationObserver`; fallback не чаще 1 раз/сек. | Значение нормализуется до целого, берётся максимум по всем найденным индикаторам. | Используется как источник глобального счётчика, когда вкладка с детальным просмотром открыта. |

> **Принцип простоты:** добавление новых детекторов или усложнение логики допускается только после согласования с заказчиком и обновления сопутствующих тестов/документации.

## Архитектура детекторов
- Контент-скрипт регистрирует `MutationObserver` на `document.documentElement` и при каждом батче (или по таймеру) запускает **один** `ActivityScanner`.
- `ActivityScanner` последовательно выполняет простые обходы DOM для D1, D2 и D4, собирая сигналы в едином массиве. Дополнительные уровни абстракции или пайплайны запрещены до согласования с заказчиком.
- `count` вычисляется как максимум из: количества сигналов D2, количества спиннеров (но не меньше 1, если найден хотя бы один), и максимального числового значения D4.
- Каждый сигнал имеет форму `{ detector, evidence, taskKey? }`; `taskKey` присутствует только там, где эвристика способна его определить.

## Стратегии устойчивости
- Локализация: текстовые детекторы используют набор ключевых слов на RU/EN; планируется вынести в конфиг для обновления без релиза.
- Изменение DOM: селекторы определены максимально общими (через роли/атрибуты). При критических изменениях обновление выполняется через release.
- Защита от ложных срабатываний: комбинация нескольких сигналов (например, наличие спиннера и кнопки Stop) повышает уверенность.
- Контент-скрипт поддерживает heartbeat: после каждого полного сканирования фиксируется `lastScanAt`, и независимо от наличия новых сигналов каждые ≤5 секунд отправляется `TASKS_HEARTBEAT`. Если alarm `PING` застал вкладку без свежего heartbeat, выполняется немедленное сканирование перед ответом.

## Приоритеты и комбинирование сигналов
- `active = true`, если сработала хотя бы одна эвристика (D1/D2/D4).
- При наличии D2 берётся фактическое количество найденных кнопок; если присутствуют только спиннеры, `count` не опускается ниже 1.
- D4 может переопределить итоговый `count`, если числовой счётчик показывает больше задач, чем найдено по кнопкам/спиннерам.
- D3 остаётся отключённым; любые попытки его включения требуют предварительного обсуждения и отдельного плана тестирования.

## Антидребезг сигналов и heartbeat
- Контент-скрипт задерживает отправку `TASKS_UPDATE` с `count=0` на 500 мс, чтобы фильтровать короткие мерцания.
- Background применяет глобальный антидребезг 12–15 секунд перед уведомлением.
- Дополнительные ограничения на частоту сигналов не вводятся: простая архитектура важнее агрессивной оптимизации. При необходимости ужесточения правил нужно предварительно согласовать изменения.
- Heartbeat (`TASKS_HEARTBEAT`) отправляется без дополнительного антидребезга и не зависит от активности детекторов; background использует его только для обновления `lastSeenAt` и статуса вкладки.
