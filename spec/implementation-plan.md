# Implementation Plan вЂ” Codex Tasks Watcher (v0.1.0)

## РђСЂС…РёС‚РµРєС‚СѓСЂРЅР°СЏ СЃС‚СЂСѓРєС‚СѓСЂР°
```
/extension
  /src
    /content
      detectors/
      index.ts           # С‚РѕС‡РєР° РІС…РѕРґР° РєРѕРЅС‚РµРЅС‚-СЃРєСЂРёРїС‚Р°
      messaging.ts
    /background
      aggregator.ts
      alarms.ts
      notifications.ts
      index.ts           # СЂРµРіРёСЃС‚СЂР°С†РёСЏ listeners
    /popup
      app.ts
      ui/
    /shared
      contracts.ts       # С‚РёРїС‹, РіРµРЅРµСЂРёСЂСѓРµРјС‹Рµ РёР· JSON Schema
      storage.ts
  /tests
    unit/
    contract/
    integration/
  manifest.json
```

## РћСЃРЅРѕРІРЅС‹Рµ С€Р°РіРё СЂРµР°Р»РёР·Р°С†РёРё
1. **Р“РµРЅРµСЂР°С†РёСЏ С‚РёРїРѕРІ**
   - РСЃРїРѕР»СЊР·РѕРІР°С‚СЊ `json-schema-to-typescript` РёР»Рё Р°РЅР°Р»РѕРі РґР»СЏ РіРµРЅРµСЂР°С†РёРё С‚РёРїРѕРІ РёР· СЃС…РµРј DTO/State.
   - Р Р°Р·РјРµСЃС‚РёС‚СЊ РіРµРЅРµСЂРёСЂСѓРµРјС‹Рµ С‚РёРїС‹ РІ `src/shared/contracts.ts` (Р°РІС‚Рѕ-РіРµРЅРµСЂР°С†РёСЏ С‡РµСЂРµР· npm script).
2. **РљРѕРЅС‚РµРЅС‚-СЃРєСЂРёРїС‚**
   - Р РµР°Р»РёР·РѕРІР°С‚СЊ РґРµС‚РµРєС‚РѕСЂС‹ D1/D2 (РјРѕРґСѓР»СЊРЅР°СЏ Р°СЂС…РёС‚РµРєС‚СѓСЂР°, РІРѕР·РјРѕР¶РЅРѕСЃС‚СЊ РїРѕРґРјРµРЅС‹).
   - РћР±СЉРµРґРёРЅРёС‚СЊ СЂРµР·СѓР»СЊС‚Р°С‚С‹, РІС‹С‡РёСЃР»СЏС‚СЊ `count`, С„РѕСЂРјРёСЂРѕРІР°С‚СЊ DTO РїРѕ СЃС…РµРјРµ.
   - РќР°СЃС‚СЂРѕРёС‚СЊ throttle/ debounce РѕС‚РїСЂР°РІРєРё СЃРѕРѕР±С‰РµРЅРёР№ Рё СЂРµР°РєС†РёСЋ РЅР° `PING`.
   - Р”РѕР±Р°РІРёС‚СЊ heartbeat-С‚Р°Р№РјРµСЂ: РєР°Р¶РґС‹Рµ в‰¤15 СЃРµРєСѓРЅРґ (Р° С‚Р°РєР¶Рµ СЃСЂР°Р·Сѓ РїРѕСЃР»Рµ `PING`) РѕС‚РїСЂР°РІР»СЏС‚СЊ `TASKS_HEARTBEAT` РїРѕ СЃС…РµРјРµ `ContentScriptHeartbeat`, РѕР±РЅРѕРІР»СЏСЏ `lastScanAt`.
3. **Background service worker**
   - РњРѕРґСѓР»СЊ `aggregator` РѕР±СЂР°Р±Р°С‚С‹РІР°РµС‚ `TASKS_UPDATE`, РѕР±РЅРѕРІР»СЏРµС‚ `AggregatedState` РІ storage.
   - РњРѕРґСѓР»СЊ `aggregator` С‚Р°РєР¶Рµ РїСЂРёРЅРёРјР°РµС‚ `TASKS_HEARTBEAT`, РїРѕРґРґРµСЂР¶РёРІР°РµС‚ РїРѕР»СЏ `lastSeenAt`, `heartbeat.status`, `missedCount` Рё РёРЅРёС†РёРёСЂСѓРµС‚ РѕС‡РёСЃС‚РєСѓ СѓСЃС‚Р°СЂРµРІС€РёС… РІРєР»Р°РґРѕРє.
   - РњРѕРґСѓР»СЊ `notifications` РєРѕРЅС‚СЂРѕР»РёСЂСѓРµС‚ Р°РЅС‚РёРґСЂРµР±РµР·Рі, СЃРѕР·РґР°С‘С‚ СѓРІРµРґРѕРјР»РµРЅРёСЏ.
   - РњРѕРґСѓР»СЊ `alarms` СѓРїСЂР°РІР»СЏРµС‚ `chrome.alarms`, РїРёРЅРіСѓРµС‚ РІРєР»Р°РґРєРё Рё РїРµСЂРµРІРѕРґРёС‚ heartbeat РІ `STALE`, РµСЃР»Рё РЅРµС‚ СЃРІРµР¶РёС… СЃРёРіРЅР°Р»РѕРІ.
   - РҐРµРЅРґР»РµСЂ `tabs.onRemoved` РїРѕРґРґРµСЂР¶РёРІР°РµС‚ РєРѕРЅСЃРёСЃС‚РµРЅС‚РЅРѕСЃС‚СЊ СЃРѕСЃС‚РѕСЏРЅРёСЏ.
   - (v0.2.0+) РџРѕРґРіРѕС‚РѕРІРёС‚СЊ РјРѕРґСѓР»СЊ `settings`, РєРѕС‚РѕСЂС‹Р№ Р±СѓРґРµС‚ РІР°Р»РёРґРёСЂРѕРІР°С‚СЊ РѕР±СЉРµРєС‚ РїРѕ `contracts/settings.schema.json` Рё СЃРёРЅС…СЂРѕРЅРёР·РёСЂРѕРІР°С‚СЊ `chrome.storage.sync`; РІ v0.1.0 Р·РЅР°С‡РµРЅРёСЏ РѕСЃС‚Р°СЋС‚СЃСЏ Р¶С‘СЃС‚РєРѕ Р·Р°РґР°РЅРЅС‹РјРё Рё РєРѕРґ РЅРµ РёСЃРїРѕР»СЊР·СѓРµС‚ `storage.sync`.
4. **Popup**
   - РџСЂРѕСЃС‚РѕРµ РѕС‚РѕР±СЂР°Р¶РµРЅРёРµ СЃРїРёСЃРєР° РІРєР»Р°РґРѕРє: Vanilla JS СЃ СЂСѓС‡РЅС‹Рј РїРѕСЃС‚СЂРѕРµРЅРёРµРј DOM-РґРµСЂРµРІР°.
   - Р—Р°РїСЂРѕСЃ СЃРѕСЃС‚РѕСЏРЅРёСЏ С‡РµСЂРµР· messaging (`POPUP_GET_STATE` в†’ РіРµРЅРµСЂР°С†РёСЏ `PopupRenderState`).
5. **РРЅС„СЂР°СЃС‚СЂСѓРєС‚СѓСЂР°**
   - РќР°СЃС‚СЂРѕРёС‚СЊ СЃР±РѕСЂРєСѓ С‡РµСЂРµР· `vite` (target: chrome >= 120, manifest v3).
   - Р”РѕР±Р°РІРёС‚СЊ СЃРєСЂРёРїС‚С‹ `npm run build`, `npm run test:unit`, `npm run test:contract`, `npm run test:integration`.
   - РџРѕРґРіРѕС‚РѕРІРёС‚СЊ `manifest.json` СЃ РјРёРЅРёРјР°Р»СЊРЅС‹РјРё СЂР°Р·СЂРµС€РµРЅРёСЏРјРё.
6. **РўРµСЃС‚С‹**
   - Unit: jest/vitest СЃ jsdom, РјРѕРє Chrome API.
   - Contract: РїСЂРѕРІРµСЂРєРё JSON Schema С‡РµСЂРµР· `ajv`/Vitest (DTO, Р°РіСЂРµРіРёСЂРѕРІР°РЅРЅРѕРµ СЃРѕСЃС‚РѕСЏРЅРёРµ, `PopupRenderState`).
   - Integration: СЃРєРІРѕР·РЅС‹Рµ СЃС†РµРЅР°СЂРёРё UC-1..UC-5 (РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ fake timers, СЃРёРјСѓР»РёСЂРѕРІР°С‚СЊ СЃРѕРѕР±С‰РµРЅРёСЏ Рё alarm `codex-poll`).

## Р—Р°РІРёСЃРёРјРѕСЃС‚Рё Рё РёРЅСЃС‚СЂСѓРјРµРЅС‚С‹
- `vite` + `typescript` РґР»СЏ СЃР±РѕСЂРєРё.
- `webextension-polyfill` (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ) РґР»СЏ СѓРЅРёС„РёС†РёСЂРѕРІР°РЅРЅРѕРіРѕ API.
- `ajv` РґР»СЏ runtime-РІР°Р»РёРґР°С†РёРё СЃС…РµРј (dev).
- РўРµСЃС‚С‹ Рё РёРЅС„СЂР°СЃС‚СЂСѓРєС‚СѓСЂР°: `vitest`, Р»РѕРєР°Р»СЊРЅС‹Р№ РїР»Р°РіРёРЅ `codex-manifest-copy` РґР»СЏ СЃР±РѕСЂРєРё MV3, РєР°СЃС‚РѕРјРЅС‹Рµ РјРѕРєРё Chrome API.

## Р РёСЃРє-РјРµРЅРµРґР¶РјРµРЅС‚
- **РР·РјРµРЅРµРЅРёРµ DOM** в†’ РєРѕРЅС„РёРіСѓСЂРёСЂСѓРµРјС‹Рµ СЃРµР»РµРєС‚РѕСЂС‹, unit-С‚РµСЃС‚С‹ РЅР° С„РёРєСЃС‚СѓСЂР°С….
- **РЎРїСЏС‰РёР№ service worker** в†’ Р±СѓРґРёР»СЊРЅРёРє `chrome.alarms`, РїРѕРІС‚РѕСЂРЅР°СЏ РёРЅРёС†РёР°Р»РёР·Р°С†РёСЏ СЃРѕСЃС‚РѕСЏРЅРёСЏ.
- **РЎР»РѕР¶РЅРѕСЃС‚СЊ С‚РµСЃС‚РѕРІ** в†’ РїСЂРµРґСѓСЃРјРѕС‚СЂРµС‚СЊ СЃР»РѕР№-Р°РґР°РїС‚РµСЂ РґР»СЏ Chrome API, С‡С‚РѕР±С‹ Р»РµРіРєРѕ РјРѕРєР°С‚СЊ.

## РљСЂРёС‚РµСЂРёРё РіРѕС‚РѕРІРЅРѕСЃС‚Рё Рє СЂРµР»РёР·Сѓ v0.1.0
- Р’СЃРµ Acceptance Criteria РёР· `spec/test-plan.md` РІС‹РїРѕР»РЅРµРЅС‹ Р°РІС‚РѕРјР°С‚РёР·РёСЂРѕРІР°РЅРЅС‹РјРё С‚РµСЃС‚Р°РјРё.
- Manifest РїСЂРѕС…РѕРґРёС‚ РїСЂРѕРІРµСЂРєСѓ Chrome Web Store Р±РµР· РїСЂРµРґСѓРїСЂРµР¶РґРµРЅРёР№.
- README РґРѕРїРѕР»РЅРµРЅРѕ РёРЅСЃС‚СЂСѓРєС†РёРµР№ РїРѕ СЃР±РѕСЂРєРµ Рё СѓСЃС‚Р°РЅРѕРІРєРµ unpacked СЂР°СЃС€РёСЂРµРЅРёСЏ.

## Р”РѕРїРѕР»РЅРёС‚РµР»СЊРЅРѕ РґР»СЏ СЂРµР»РёР·Р° v0.2.0
- Р РµР°Р»РёР·РѕРІР°РЅС‹ UI/РѕРїС†РёРё РґР»СЏ СЂРµРґР°РєС‚РёСЂРѕРІР°РЅРёСЏ РЅР°СЃС‚СЂРѕРµРє `CodexTasksUserSettings`.
- Background СЃРёРЅС…СЂРѕРЅРёР·РёСЂСѓРµС‚ Рё РІР°Р»РёРґРёСЂСѓРµС‚ РЅР°СЃС‚СЂРѕР№РєРё, РїСЂРёРјРµРЅСЏРµС‚ `autoDiscardableOff`, `debounceMs`, `sound`, `showBadgeCount` РєРѕ РІСЃРµРј РѕС‚РєСЂС‹С‚С‹Рј РІРєР»Р°РґРєР°Рј.
- РџРѕРєСЂС‹С‚РёРµ С‚РµСЃС‚Р°РјРё СЃС†РµРЅР°СЂРёРµРІ РёР·РјРµРЅРµРЅРёСЏ РЅР°СЃС‚СЂРѕРµРє Рё РёС… РІР»РёСЏРЅРёСЏ РЅР° СѓРІРµРґРѕРјР»РµРЅРёСЏ, Р±РµР№РґР¶ Рё autoDiscardable.
### Action indicator rollout (v0.1.x)
- Extend background bootstrap with action badge controller (see spec/action-indicator.md).
- Derive badge text/color from AggregatedState.lastTotal; throttle updates to <=4 Hz.
- Ensure controller exposes pure helpers for unit tests and degrades gracefully when chrome.action is missing.
### Audio completion cue (v0.1.x)
- Инициализировать аудиоконтроллер в background (Web Audio API, OffscreenCanvas не требуется).
- Popup отправляет POPUP_ACTIVATE_AUDIO, создавая AudioContext и подготавливая gain/gain envelope.
- Контроллер слушает изменения агрегатора и воспроизводит сигнал (mp3/осциллятор) при переходе счётчика из >0 в 0.
- Подготовить расширяемые точки для будущих настроек громкости и отключения.
