# Use Cases — Codex Tasks Watcher

## UC-1: Уведомление при завершении единственной задачи
- **Акторы:** Пользователь Codex, контент-скрипт, background service worker, Chrome Notifications.
- **Предусловия:** Открыта хотя бы одна вкладка Codex; расширение установлено и активно.
- **Основной поток:**
  1. Пользователь запускает задачу в Codex.
  2. Контент-скрипт фиксирует появление спиннера (детектор D1) и отправляет `TASKS_UPDATE` с `active=true`, `count>=1`.
  3. Background обновляет состояние, увеличивает `totalActiveCount` > 0 и не показывает уведомление.
  4. По завершении задачи контент-скрипт отправляет `TASKS_UPDATE` с `count=0`.
  5. Background фиксирует переход `totalActiveCount` с >0 до 0, запускает таймер антидребезга.
  6. По истечении окна антидребезга (≈12–15 с) background проверяет, что `totalActiveCount` всё ещё 0, и создаёт уведомление «Все задачи в Codex завершены».
- **Альтернативы:**
  - Задача завершается до истечения антидребезга, но появляется новый спиннер — таймер сбрасывается.
- **Ошибки:**
  - Вкладка закрыта до отправки финального `TASKS_UPDATE` → background удаляет состояние вкладки, суммирует оставшиеся, если счётчик >0, уведомление не показывается.
- **Постусловия:** Уведомление показано один раз, состояние вкладок обнулено.

## UC-2: Параллельные задачи в нескольких вкладках
- **Акторы:** Пользователь, несколько контент-скриптов, background.
- **Предусловия:** Открыто ≥2 вкладок Codex с активными задачами.
- **Основной поток:**
  1. На каждой вкладке запускаются задачи; контент-скрипты отправляют `TASKS_UPDATE` с `count>0`.
  2. Background агрегирует состояния и получает `totalActiveCount = n`, где n > 1.
  3. По мере завершения задач вкладки отправляют `count=0`, background уменьшает суммарное значение.
  4. Уведомление создаётся только после получения `count=0` от всех вкладок и выдержки антидребезга.
- **Альтернативы:**
  - Одна вкладка продолжает работу, пока другие завершены → уведомление не показывается.
- **Ошибки:**
  - Потеря связи с вкладкой: alarm `codex-poll` инициирует повторный `PING`, чтобы восстановить актуальное состояние.
- **Постусловия:** `totalActiveCount=0`, popup отображает «Нет активных задач».

## UC-3: Вспышки активности (антидребезг)
- **Акторы:** Пользователь, контент-скрипт, background.
- **Предусловия:** Задачи завершены, но UI кратковременно показывает спиннер (например, обновление списка).
- **Основной поток:**
  1. Контент-скрипт фиксирует появление спиннера D1 и отправляет `TASKS_UPDATE` с `count=1`.
  2. Через <1 секунды после исчезновения спиннера (debounce контент-скрипта 500 мс) отправляется `TASKS_UPDATE` с `count=0`.
  3. Background обнаруживает, что `totalActiveCount` вернулся в 0, но антидребезг ещё не истёк.
  4. Если в течение окна антидребезга новых сигналов нет, уведомление показывается. Если сигнал повторяется, окно продлевается.
- **Альтернативы:**
  - Настоящая задача стартует в течение окна → `count` снова >0, антидребезг сбрасывается.
- **Ошибки:**
  - Вкладка выгружается системой до завершения окна → background применяет `autoDiscardableOff`, чтобы предотвратить выгрузку.
- **Постусловия:** Пользователь видит уведомление только если активность действительно завершилась.

## UC-4: Отображение списка активных задач в popup
- **Акторы:** Пользователь, popup UI, background.
- **Предусловия:** Есть хотя бы одна вкладка Codex с `count>0`.
- **Основной поток:**
  1. Пользователь открывает popup расширения.
  2. Popup отправляет сообщение `POPUP_GET_STATE` через `chrome.runtime.sendMessage`, пробуждая service worker при необходимости.
  3. Background формирует `PopupRenderState`: снимает текущее состояние из агрегатора, вычисляет `totalActive`, сортирует вкладки по `count`/`lastSeenAt`, добавляет локализованные тексты.
  4. Popup отображает перечень задач в порядке важности; сигналы показываются в списке внутри карточки вкладки.
- **Альтернативы:**
  - Если `count=0` по всем вкладкам, popup показывает состояние «Нет активных задач».
- **Ошибки:**
  - Сервис-воркер спит → popup повторяет `chrome.runtime.sendMessage`, чтобы гарантированно разбудить воркер и получить ответ.
- **Постусловия:** Пользователь получает актуальную сводку задач без лишних действий.


## UC-5: Потеря heartbeat и автоматическое восстановление
- **Акторы:** Контент-скрипт, background service worker, Chrome Alarms.
- **Предусловия:** Вкладка Codex открыта, активных задач нет (`count=0`), но контент-скрипт перестал отправлять `TASKS_HEARTBEAT` (например, вкладка свернута и заморожена).
- **Основной поток:**
  1. Alarm `codex-poll` срабатывает, вызывает `evaluateHeartbeatStatuses()` и обнаруживает, что `now - lastReceivedAt >= expectedIntervalMs * 3`; вкладка помечается как `STALE`, `missedCount` увеличивается.
  2. Background отправляет вкладке сообщение `PING`.
  3. Контент-скрипт получает `PING`, немедленно выполняет сканирование DOM, формирует актуальный `TASKS_UPDATE` и `TASKS_HEARTBEAT` (с `respondingToPing=true`).
  4. Background обновляет `lastSeenAt`, сбрасывает `missedCount`, статус становится `OK` и вкладка снова учитывается в агрегированном состоянии.
- **Альтернативы:**
  - Вкладка закрыта до отправки `PING` → событие `tabs.onRemoved` удаляет состояние, heartbeat больше не ожидается.
- **Ошибки:**
  - Контент-скрипт не отвечает на `PING` → background повторяет попытку на следующем alarm и логирует предупреждение для диагностики.
- **Постусловия:** `lastSeenAt` отражает реальное время последнего контакта; если вкладка не восстановилась, background продолжает помечать её как `STALE` и не учитывает устаревшие данные при расчёте уведомлений.
## UC-6: Monitoring Codex tasks from the toolbar badge
- **Actors:** Background worker, Chrome toolbar, Codex operator.
- **Preconditions:** Aggregator is active; extension action is pinned in the toolbar.
- **Main Flow:**
  1. Aggregator receives TASKS_UPDATE and updates lastTotal.
  2. Action indicator derives badge text/color and updates chrome.action APIs.
  3. Operator glances at the toolbar badge and sees the current count and severity color.
- **Alternatives:** If chrome.action APIs are unavailable, the indicator logs a warning and keeps previous badge value.
- **Postconditions:** Badge reflects the newest aggregated count; tooltip matches the localized template.
