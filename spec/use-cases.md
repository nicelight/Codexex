# Use Cases — Codex Tasks Watcher

## UC-1: Уведомление при завершении единственной задачи
- **Акторы:** Пользователь Codex, контент-скрипт, background service worker, Chrome Notifications.
- **Предусловия:** Открыта хотя бы одна вкладка Codex; расширение установлено и активно.
- **Основной поток:**
  1. Пользователь запускает задачу в Codex.
  2. Контент-скрипт фиксирует появление спиннера (детектор D1) и отправляет `TASKS_UPDATE` с `active=true`, `count>=1`.
  3. Background обновляет состояние, увеличивает `totalActiveCount` > 0 и не показывает уведомление.
  4. По завершении задачи контент-скрипт отправляет `TASKS_UPDATE` с `count=0`.
  5. Background фиксирует переход `totalActiveCount` с >0 до 0, запускает таймер антидребезга.
  6. По истечении окна антидребезга (≈12–15 с) background проверяет, что `totalActiveCount` всё ещё 0, и создаёт уведомление «Все задачи в Codex завершены».
- **Альтернативы:**
  - Задача завершается до истечения антидребезга, но появляется новый спиннер — таймер сбрасывается.
- **Ошибки:**
  - Вкладка закрыта до отправки финального `TASKS_UPDATE` → background удаляет состояние вкладки, суммирует оставшиеся, если счётчик >0, уведомление не показывается.
- **Постусловия:** Уведомление показано один раз, состояние вкладок обнулено.

## UC-2: Параллельные задачи в нескольких вкладках
- **Акторы:** Пользователь, несколько контент-скриптов, background.
- **Предусловия:** Открыто ≥2 вкладок Codex с активными задачами.
- **Основной поток:**
  1. На каждой вкладке запускаются задачи; контент-скрипты отправляют `TASKS_UPDATE` с `count>0`.
  2. Background агрегирует состояния и получает `totalActiveCount = n`, где n > 1.
  3. По мере завершения задач вкладки отправляют `count=0`, background уменьшает суммарное значение.
  4. Уведомление создаётся только после получения `count=0` от всех вкладок и выдержки антидребезга.
- **Альтернативы:**
  - Одна вкладка продолжает работу, пока другие завершены → уведомление не показывается.
- **Ошибки:**
  - Потеря связи с вкладкой: alarm `codex-poll` инициирует повторный `PING`, чтобы восстановить актуальное состояние.
- **Постусловия:** `totalActiveCount=0`, popup отображает «Нет активных задач».

## UC-3: Вспышки активности (антидребезг)
- **Акторы:** Пользователь, контент-скрипт, background.
- **Предусловия:** Задачи завершены, но UI кратковременно показывает спиннер (например, обновление списка).
- **Основной поток:**
  1. Контент-скрипт фиксирует появление спиннера D1 и отправляет `TASKS_UPDATE` с `count=1`.
  2. Через <5 секунд спиннер исчезает, отправляется `TASKS_UPDATE` с `count=0`.
  3. Background обнаруживает, что `totalActiveCount` вернулся в 0, но антидребезг ещё не истёк.
  4. Если в течение окна антидребезга новых сигналов нет, уведомление показывается. Если сигнал повторяется, окно продлевается.
- **Альтернативы:**
  - Настоящая задача стартует в течение окна → `count` снова >0, антидребезг сбрасывается.
- **Ошибки:**
  - Вкладка выгружается системой до завершения окна → background применяет `autoDiscardableOff`, чтобы предотвратить выгрузку.
- **Постусловия:** Пользователь видит уведомление только если активность действительно завершилась.

## UC-4: Отображение списка активных задач в popup
- **Акторы:** Пользователь, popup UI, background.
- **Предусловия:** Есть хотя бы одна вкладка Codex с `count>0`.
- **Основной поток:**
  1. Пользователь открывает popup расширения.
  2. Popup запрашивает текущее состояние у background (`chrome.runtime.sendMessage` или `chrome.storage.session.get`).
  3. Background возвращает список вкладок с полями `title`, `count`, `signals`.
  4. Popup отображает перечень задач, позволяет пользователю кликнуть для перехода к вкладке.
- **Альтернативы:**
  - Если `count=0` по всем вкладкам, popup показывает состояние «Нет активных задач».
- **Ошибки:**
  - Сервис-воркер спит → popup инициирует восстановление через `chrome.runtime.getBackgroundPage` (MV3: `runtime.sendMessage` запускает воркер).
- **Постусловия:** Пользователь получает актуальную сводку задач без лишних действий.
