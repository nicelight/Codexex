# Test Plan & Acceptance Criteria — Codex Tasks Watcher

## Цели тестирования
- Подтвердить соответствие контент-скрипта и background спецификациям JSON Schema.
- Проверить корректность антидребезга и уникальность уведомлений.
- Убедиться, что popup отображает актуальное состояние задач.

## Область покрытия
- Юнит-тесты детекторов и агрегатора.
- Контрактные тесты HTTP-адаптера (OpenAPI).
- Интеграционные сценарии с имитацией вкладок и сообщений.

## Acceptance Criteria
1. **AC1 — Уведомление по завершении всех задач**
   - Given несколько вкладок с активными задачами (`count>0`),
   - When каждая вкладка отправляет `TASKS_UPDATE` с `count=0`, а антидребезг истёк,
   - Then создаётся ровно одно уведомление «Все задачи в Codex завершены» и `debounce.since` сбрасывается.
2. **AC2 — Антидребезг защищает от ложных срабатываний**
   - Given вкладка отправляет `TASKS_UPDATE` с `count=0`,
   - When в течение окна антидребезга приходит новое сообщение с `count>0`,
   - Then уведомление не создаётся и окно начинается заново.
3. **AC3 — Popup отображает актуальные данные**
   - Given в `AggregatedState` содержатся вкладки с `count>0`,
   - When popup запрашивает `/popup/state`,
   - Then в ответе перечислены вкладки с корректными `count`, `title`, `signals`.
4. **AC4 — Контент-скрипт соблюдает Schema**
   - Given контент-скрипт отправляет `TASKS_UPDATE`,
   - When сообщение валидируется по `contracts/dto/content-update.schema.json`,
   - Then валидация проходит без ошибок, обязательные поля присутствуют.
5. **AC5 — Обработка закрытия вкладок**
   - Given вкладка с `count>0` закрывается (без финального сообщения),
   - When background получает событие `tabs.onRemoved`,
   - Then состояние вкладки удаляется, `lastTotal` пересчитывается, уведомление не создаётся, если есть другие активные задачи.

## Типы тестов
- **Unit**
  - Детекторы: корректное определение активности по тестовым DOM-фрагментам.
  - Агрегатор: переходы состояний `lastTotal`, антидребезг.
- **Contract**
  - Валидация OpenAPI: `POST /background/tasks-update`, `GET /background/state`, `GET /popup/state`.
  - JSON Schema: сериализация `AggregatedState` и `PopupRenderState`.
- **Integration**
  - Симуляция Chrome APIs (tabs, alarms, notifications) через фейки. Проверка сценариев UC-1..UC-4.

## Тестовые данные
- DOM-фрагменты для детекторов D1/D2/D3 на RU/EN интерфейсах.
- Моки Chrome API: `tabs.query`, `notifications.create`, `storage.session`.
- Набор последовательностей сообщений для воспроизведения сценариев (см. `spec/use-cases.md`).

## Метрики и отчётность
- Покрытие unit-тестов по файлам детекторов ≥80%.
- Контрактные тесты выполняются в CI при каждом PR.
- Отчёт о прогоне включается в PR (лог pytest + результаты валидации OpenAPI).

## Инструменты
- Jest/Vitest (или аналог) для unit-тестов в среде jsdom.
- `ajv` для проверки JSON Schema в тестах.
- `schemathesis` или `dredd` для контрактного тестирования OpenAPI адаптера.

## Риски и mitigations
- Изменение DOM на стороне Codex → предусмотреть возможность обновления фикстур DOM.
- Ограничения Manifest V3 (спящий воркер) → интеграционные тесты моделируют таймеры `chrome.alarms`.
