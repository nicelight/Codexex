# Roadmap: Spec Package Delivery

> Следуем Spec-Driven Development: выполняем задачи последовательно, не приступаем к реализации, пока не завершён весь необходимый объём спецификаций.

## Структура работ

| № | Этап | Цель и ключевые действия | Артефакты | Статус |
|---|------|---------------------------|-----------|--------|
| 1 | Анализ брифа и существующих материалов | Подтвердить понимание контекста, ограничений и целевых платформ. Зафиксировать исходные требования, выявить пробелы. | Отчёт о анализе (summary) в `spec/context.md` | ☑ DONE |
| 2 | Scope & Stakeholders | Уточнить персоны, акторов, внешние зависимости, границы системы. | Раздел «Stakeholders & Scope» в `spec/context.md` | ☑ DONE |
| 3 | Domain Glossary | Сформировать словарь ключевых терминов и сущностей, согласовать названия. | `spec/domain-glossary.md` | ☑ DONE |
| 4 | Use Cases & User Journeys | Описать основные и альтернативные сценарии, предусловия/постусловия. | `spec/use-cases.md` с минимум 3 сценариями | ☑ DONE |
| 5 | Системные функции и состояния | Разбить на capabilities/функциональные требования; описать состояния и триггеры. | `spec/system-capabilities.md` | ☑ DONE |
| 6 | Детекторы и сигналы | Формализовать детекторы DOM/событий, их приоритеты, стратегии антидребезга. | `spec/detectors.md` | ☑ DONE |
| 7 | NFR и эксплуатационные требования | Зафиксировать производительность, надёжность, безопасность, UX-ограничения, политику хранения данных. | `spec/nfr.md` | ☑ DONE |
| 8 | Контракты обмена данными | Детализировать DTO, события, состояния. Разработать JSON Schema для сообщений и хранения. | JSON Schema файлы в `contracts/` (например, `contracts/dto/content-update.schema.json`) | ☑ DONE |
| 9 | OpenAPI спецификация | Сформировать OpenAPI для публичных/внутренних точек расширения (если необходимы), включить модели. | `contracts/openapi.yaml` | ☑ DONE |
|10 | Диаграммы последовательностей и состояний | Описать ключевые потоки: обнаружение задач, агрегация, выдача уведомления. | Mermaid-диаграммы в `spec/diagrams/*.md` | ☑ DONE |
|11 | Acceptance Criteria & Test Plan | Определить проверяемые условия, позитивные/негативные кейсы, контрактные тесты. | `spec/test-plan.md` | ☑ DONE |
|12 | План реализации (Skeleton Outline) | Подготовить структуру каталогов, роли скриптов, зависимости. | `spec/implementation-plan.md` | ☑ DONE |
|13 | Review & Sign-off | Провести самопроверку соответствия брифу, выявить риски, подготовить summary для утверждения. | Checklist и выводы в `spec/review.md` | ☑ DONE |

## Правила выполнения

1. Работать строго последовательно по таблице. Переход на следующий этап только после фиксации артефактов текущего.
2. Все артефакты хранить в Markdown/JSON, следуя структуре каталогов.
3. Любые новые вопросы или неоднозначности документировать и эскалировать до их разрешения.
4. После завершения этапа обновлять статус (☑ DONE) и при необходимости ссылаться на связанные документы.
5. Перед началом реализации убедиться, что чек-лист SDD (контракты, NFR, диаграммы, тест-план) полностью закрыт.

---

# Roadmap: Реализация кода (v0.1.0)

> Отправная точка — полный пакет спецификаций (см. таблицу выше). Ниже перечислены шаги для реализации расширения Chrome с учётом зависимостей и ожидаемых артефактов.

## Фаза 0. Подготовка инфраструктуры проекта ✅

- [x] **Инициализация репозитория под сборку MV3**
  - [x] Создать `package.json`, подключить `vite`, `typescript`, `vitest`, `@types/chrome`, настроить локальный плагин сборки Manifest V3 согласно `spec/implementation-plan.md`.
  - [x] Настроить `tsconfig.json` с alias для `src/*`, включить строгий режим типов.
  - [x] Добавить базовую структуру каталогов `/extension/src/...` и конфиги форматирования (Prettier/ESLint при необходимости).
- [x] **Manifest & build pipeline**
  - [x] Создать `manifest.json` (MV3) с минимальными разрешениями (`notifications`, `alarms`, `storage`, `tabs`, `scripting`, `host_permissions`).
  - [x] Настроить `vite.config.ts` для сборки background service worker, content-script и popup.
  - [x] Добавить npm-скрипты: `build`, `dev`, `lint` (если применимо), `test:unit`, `test:contract`, `test:integration`.

## Фаза 1. Общие модули и контракты ✅

- [x] **Генерация типов и валидация**
  - [x] Реализовать скрипт генерации типов из JSON Schema в `src/shared/contracts.ts` (использовать `json-schema-to-typescript` или альтернативу).
  - [x] Настроить runtime-валидацию DTO и состояния с помощью `ajv` (dev-зависимость), экспортировать helper-функции.
- [x] **Адаптер Chrome API**
  - [x] Создать thin-wrapper в `src/shared/chrome.ts` с типами и мок-стабами для тестов.
  - [x] Определить общий интерфейс логирования и утилиты времени (throttle/debounce, `requestIdleCallback` полифилл для тестов).

## Фаза 2. Content-script ✅ (v0.1.0)

- [x] **Бутстрап и обмен сообщениями**
  - [x] Создать точку входа `src/content/index.ts`, которая инициализирует детекторы, подписки и логирование (reuse shared logger).
  - [x] Зафиксировать контракт `ContentScriptTasksUpdate` и подготовить helper-функции (`postToBackground`, `onBackgroundEvent`), работающие с сообщением `TASKS_UPDATE` из `contracts/dto/content-update.schema.json`.
- [x] **Модульная система детекторов**
  - [x] Реализовать интерфейс `Detector` c методами `bootstrap`, `scan`, `teardown`, обеспечив смену локали без перезагрузки.
  - [x] Внедрить детекторы D1 (spinner) и D2 (Stop button) с DOM-фикстурами и unit-тестами для RU/EN.
  - [x] Подготовить стаб D3 (см. раздел `D3_CARD_HEUR` в `spec/detectors.md`) под feature flag и зафиксировать ограничения до v0.2.0.
- [x] **Пайплайн агрегации сигналов**
  - [x] Объединить результаты детекторов в `aggregateDetections`, нормализуя данные по DTO `TASKS_UPDATE`.
  - [x] Настроить антидребезг/throttle (включая `requestIdleCallback`/таймер) и задокументировать константы (`debounceMs`, `heartbeatMs`).
  - [x] Сохранять последнюю метку сканирования для дедупликации событий и покрыть граничные случаи unit-тестами.
- [x] **Связь с background и устойчивость**
  - [x] Обрабатывать входящие сообщения (`PING`, `RESET`, `REQUEST_STATE`) с повторным подключением после `runtime.lastError`.
  - [x] Поддерживать fail-safe таймер сканирования DOM (heartbeat): каждые ≤15 секунд формировать `TASKS_HEARTBEAT` по схеме `contracts/dto/content-heartbeat.schema.json` и экспортировать типы через `shared/contracts`.
  - [x] Логировать ключевые события (инициализация, heartbeat, ошибки отправки) и учитывать verbose-флаг из `chrome.storage.session`.

## Фаза 3. Background service worker ✅ (v0.1.0)

- [x] **Каркас service worker**
  - [x] Создать точку входа `src/background/index.ts` с регистрацией listeners (`runtime`, `tabs`, `alarms`, `storage`).
  - [x] Организовать маршрутизацию сообщений через единый диспетчер (`handleMessage`) и покрыть happy path + ошибки `runtime.lastError` unit-тестами.
- [x] **Агрегатор состояния и хранение**
  - [x] Реализовать `aggregator.ts` для обработки `TASKS_UPDATE` и `TASKS_HEARTBEAT`, поддержки нескольких вкладок и обновления `chrome.storage.session` по схеме `contracts/state/aggregated-state.schema.json`
    (см. `AggregatedTabsState`).
  - [x] Добавить retry-механику записи состояния (до 3 попыток с интервалом ~1 c) и логировать неудачи.
  - [x] Синхронизировать heartbeat и `lastSeenAt` вкладок, переводить `heartbeat.status` в `STALE` при пропусках и покрыть рестарт service worker тестами.
- [x] **Уведомления, i18n и логирование**
  - [x] Реализовать `notifications.ts` с антидребезгом и локализованными строками (RU/EN) через общий i18n-слой.
  - [x] Инкапсулировать одиночное уведомление при переходе `totalActiveCount` > 0 → 0 и очистку при новых задачах.
  - [x] Управлять verbose-логированием: читать флаг из `chrome.storage.session`, переключать уровень и покрыть адаптер тестами.
- [x] **Алгоритмы будильников и устойчивость**
  - [x] Реализовать `alarms.ts` с расписанием `chrome.alarms`, поддержкой повторных `PING` и восстановлением после sleep.
  - [x] Применять `autoDiscardableOff` для вкладок Codex, документировать side-effects и проверять сценарии
    alarm → message → state.
- [x] **Наблюдаемость и телеметрия**
  - [x] Логировать ключевые события: `TASKS_UPDATE`, запуск/завершение уведомлений, ошибки чтения/записи `storage.session`,
    пропуски heartbeat, применение `autoDiscardableOff`.
  - [x] Покрыть logging-адаптер тестами на чтение/обновление флага, фильтрацию verbose-событий и fallback при
    `chrome.runtime.lastError`.

## Фаза 4. Popup UI ✅ (v0.1.0)

- [x] **Интеграция со state**
  - [x] Создать адаптер, запрашивающий агрегированное состояние у background (`chrome.runtime.sendMessage`).
  - [x] Реализовать отображение списка вкладок/сигналов и fallback «Нет активных задач».
- [x] **UX и локализация**
  - [x] Добавить базовый стиль (CSS/HTMX шаблоны), обеспечить поддержку RU/EN текстов.
  - [x] Покрыть рендер unit-тестами (jsdom/snapshots) и проверить устойчивость к пустым/большим спискам.

## Фаза 5. Тестирование и качество ⏳ (v0.1.0)

- [ ] **Unit tests**
  - [ ] Подготовить общие моки Chrome API и time-helpers для повторного использования в разных пакетах.
  - [ ] Покрыть детекторы (D1/D2 + заглушка D3), агрегатор, уведомления, storage helper'ы и verbose-логирование (`vitest`).
  - [ ] Добавить negative-cases: ошибки записи `storage.session`, неверные сообщения, потерю heartbeat.
  - [ ] Запланировать тест, подтверждающий переключение RU/EN уведомлений согласно требованию «Уведомления формулируются на языке интерфейса браузера» из `spec/nfr.md`.
- [ ] **Contract tests**
  - [ ] Реализовать проверку DTO/state JSON Schema (`ajv`/`schemathesis`) в CI-скрипте.
  - [ ] Валидировать OpenAPI (`contracts/openapi.yaml`) против background/popup-хендлеров (включая `/background/tasks-heartbeat`) и задокументировать команды запуска.
- [ ] **Локальный HTTP-адаптер для тестов**
  - [ ] Реализовать `msw` (или аналогичный) адаптер, эмулирующий `/background/tasks-update`, `/background/tasks-heartbeat`, `/background/state`, `/popup/state`.
  - [ ] Подключить контрактные проверки по `contracts/openapi.yaml`, DTO/State/Settings согласно требованиям `spec/test-plan.md`.
- [ ] **Integration tests**
  - [ ] Смоделировать ключевые use-cases (UC-1..UC-3) с фейковым DOM, обменом сообщениями и будильниками.
  - [ ] Проверить устойчивость к перезапуску service worker, закрытию вкладок и переключению verbose-флага.

## Фаза 6. Документация, упаковка и QA ⏳ (v0.1.0)

- [ ] **Документация**
  - [ ] Обновить `README.md` инструкциями по сборке (`npm install`, `npm run build`, установка unpacked расширения).
  - [ ] Зафиксировать Known Issues и TODO для релиза v0.2.0 (настройки, бейдж, звук).
- [ ] **Сборка и ручное тестирование**
  - [ ] Подготовить production build и проверить в Chrome (режим разработчика).
  - [ ] Провести смоук-тесты: одиночная вкладка, несколько вкладок, сон service worker.
- [ ] **Готовность к релизу**
  - [ ] Собрать пакет для Chrome Web Store (zip), убедиться в соответствии требованиям (раздел «Критерии готовности» в `spec/implementation-plan.md`).
  - [ ] Сформировать CHANGELOG и план следующих итераций (v0.2.0).

## Backlog v0.2.0 — Расширение детекторов

> Задачи для следующей итерации. Фокус — поэтапный rollout детектора D3_CARD_HEUR согласно `spec/detectors.md`, после стабилизации релиза v0.1.0.

- [ ] **Активация D3_CARD_HEUR в пайплайне**
  - [ ] Добавить конфигурацию/feature-flag, разрешающую запуск D3 только когда D1/D2 не дают активность, соблюдая приоритеты из `spec/detectors.md` (раздел `D3_CARD_HEUR`).
  - [ ] Обновить агрегатор сигналов, чтобы `count` учитывал D3 наравне с D2 при включённом флаге, сохраняя пометку низкой надёжности для background.
  - [ ] Описать процесс включения в release notes (какие сценарии активируют эвристику, как откатывать).
- [ ] **Фикстуры и unit-тесты для D3**
  - [ ] Подготовить DOM-фрагменты карточек с текстами `Running`/`Выполняется`, таймерами и статусами, покрывая кейсы из `spec/detectors.md`.
  - [ ] Написать тесты, проверяющие корректный подсчёт `signals` и `count`, а также совместную работу с D1/D2 при комбинированных входах.
  - [ ] Зафиксировать негативные сценарии (ложные срабатывания) и убедиться, что D3 не отправляет `count>0`, когда индикаторы отсутствуют.
- [ ] **Антидребезг и интеграция**
  - [ ] Настроить отдельный таймаут антидребезга для D3 (инициируется только при новых сигналах), синхронизировать с 500 мс задержкой контент-скрипта и 12–15 сек в background.
  - [ ] Добавить интеграционные тесты, эмулирующие переключение между D1/D2 и D3, чтобы подтвердить плавную деградацию.
  - [ ] Обновить документацию `spec/test-plan.md` ссылкой на новые сценарии и критерии готовности D3.
