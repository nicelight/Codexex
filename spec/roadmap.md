# Roadmap: Spec Package Delivery

> Следуем Spec-Driven Development: выполняем задачи последовательно, не приступаем к реализации, пока не завершён весь необходимый объём спецификаций.

## Структура работ

| № | Этап | Цель и ключевые действия | Артефакты | Статус |
|---|------|---------------------------|-----------|--------|
| 1 | Анализ брифа и существующих материалов | Подтвердить понимание контекста, ограничений и целевых платформ. Зафиксировать исходные требования, выявить пробелы. | Отчёт о анализе (summary) в `spec/context.md` | ☑ DONE |
| 2 | Scope & Stakeholders | Уточнить персоны, акторов, внешние зависимости, границы системы. | Раздел «Stakeholders & Scope» в `spec/context.md` | ☑ DONE |
| 3 | Domain Glossary | Сформировать словарь ключевых терминов и сущностей, согласовать названия. | `spec/domain-glossary.md` | ☑ DONE |
| 4 | Use Cases & User Journeys | Описать основные и альтернативные сценарии, предусловия/постусловия. | `spec/use-cases.md` с минимум 3 сценариями | ☑ DONE |
| 5 | Системные функции и состояния | Разбить на capabilities/функциональные требования; описать состояния и триггеры. | `spec/system-capabilities.md` | ☑ DONE |
| 6 | Детекторы и сигналы | Формализовать детекторы DOM/событий, их приоритеты, стратегии антидребезга. | `spec/detectors.md` | ☑ DONE |
| 7 | NFR и эксплуатационные требования | Зафиксировать производительность, надёжность, безопасность, UX-ограничения, политику хранения данных. | `spec/nfr.md` | ☑ DONE |
| 8 | Контракты обмена данными | Детализировать DTO, события, состояния. Разработать JSON Schema для сообщений и хранения. | JSON Schema файлы в `contracts/` (например, `contracts/dto/content-update.schema.json`) | ☑ DONE |
| 9 | OpenAPI спецификация | Сформировать OpenAPI для публичных/внутренних точек расширения (если необходимы), включить модели. | `contracts/openapi.yaml` | ☑ DONE |
|10 | Диаграммы последовательностей и состояний | Описать ключевые потоки: обнаружение задач, агрегация, выдача уведомления. | Mermaid-диаграммы в `spec/diagrams/*.md` | ☑ DONE |
|11 | Acceptance Criteria & Test Plan | Определить проверяемые условия, позитивные/негативные кейсы, контрактные тесты. | `spec/test-plan.md` | ☑ DONE |
|12 | План реализации (Skeleton Outline) | Подготовить структуру каталогов, роли скриптов, зависимости. | `spec/implementation-plan.md` | ☑ DONE |
|13 | Review & Sign-off | Провести самопроверку соответствия брифу, выявить риски, подготовить summary для утверждения. | Checklist и выводы в `spec/review.md` | ☑ DONE |

## Правила выполнения

1. Работать строго последовательно по таблице. Переход на следующий этап только после фиксации артефактов текущего.
2. Все артефакты хранить в Markdown/JSON, следуя структуре каталогов.
3. Любые новые вопросы или неоднозначности документировать и эскалировать до их разрешения.
4. После завершения этапа обновлять статус (☑ DONE) и при необходимости ссылаться на связанные документы.
5. Перед началом реализации убедиться, что чек-лист SDD (контракты, NFR, диаграммы, тест-план) полностью закрыт.

---

# Roadmap: Реализация кода (v0.1.0)

> Отправная точка — полный пакет спецификаций (см. таблицу выше). Ниже перечислены шаги для реализации расширения Chrome с учётом зависимостей и ожидаемых артефактов.

## Фаза 0. Подготовка инфраструктуры проекта ⏳

- [ ] **Инициализация репозитория под сборку MV3**
  - [ ] Создать `package.json`, подключить `vite`, `typescript`, `vitest`, `@types/chrome`, `@webext-core/mv3-vite` (либо аналогичный плагин) согласно `spec/implementation-plan.md`.
  - [ ] Настроить `tsconfig.json` с alias для `src/*`, включить строгий режим типов.
  - [ ] Добавить базовую структуру каталогов `/extension/src/...` и конфиги форматирования (Prettier/ESLint при необходимости).
- [ ] **Manifest & build pipeline**
  - [ ] Создать `manifest.json` (MV3) с минимальными разрешениями (`notifications`, `alarms`, `storage`, `tabs`, `scripting`, `host_permissions`).
  - [ ] Настроить `vite.config.ts` для сборки background service worker, content-script и popup.
  - [ ] Добавить npm-скрипты: `build`, `dev`, `lint` (если применимо), `test:unit`, `test:contract`, `test:integration`.

## Фаза 1. Общие модули и контракты ⏳

- [ ] **Генерация типов и валидация**
  - [ ] Реализовать скрипт генерации типов из JSON Schema в `src/shared/contracts.ts` (использовать `json-schema-to-typescript` или альтернативу).
  - [ ] Настроить runtime-валидацию DTO и состояния с помощью `ajv` (dev-зависимость), экспортировать helper-функции.
- [ ] **Адаптер Chrome API**
  - [ ] Создать thin-wrapper в `src/shared/chrome.ts` с типами и мок-стабами для тестов.
  - [ ] Определить общий интерфейс логирования и утилиты времени (throttle/debounce, `requestIdleCallback` полифилл для тестов).

## Фаза 2. Content-script ⏳

- [ ] **Бутстрап и инфраструктура контент-скрипта**
  - [ ] Создать модуль точки входа `src/content/index.ts`, который инициализирует детекторы, подписки и логирование (reuse shared logger).
  - [ ] Зафиксировать контракт обмена сообщениями (тип `ContentMessage`) и подготовить helper для отправки/приёма (`postToBackground`, `onBackgroundEvent`).
- [ ] **Модульная система детекторов**
  - [ ] Реализовать интерфейс `Detector` c методами `bootstrap`, `scan`, `teardown`, обеспечив горячее переключение локали.
  - [ ] Реализовать детектор D1 (spinner) с фикстурами DOM и unit-тестами на RU/EN.
  - [ ] Реализовать детектор D2 (Stop button) с проверкой альтернативных селекторов и unit-тестами.
  - [ ] Зафиксировать backlog-задачу на D3 (`spec/detectors.md#d3_card_heur`) с описанием ожиданий для версии v0.2.0 и подготовить стаб в кодовой базе (feature flag).
- [ ] **Пайплайн агрегации сигналов**
  - [ ] Объединить результаты детекторов в `aggregateDetections`, нормализовать данные по контракту `TASKS_UPDATE`.
  - [ ] Настроить антидребезг и throttle (включая `requestIdleCallback`/таймер) и задокументировать константы (`debounceMs`, `heartbeatMs`).
  - [ ] Сохранить «последнюю метку» сканирования для дедупликации событий и покрыть unit-тестами граничные случаи (нет задач / появление / исчезновение).
- [ ] **Связь с background и устойчивость**
  - [ ] Реализовать обработку входящих сообщений (`PING`, `RESET`, `REQUEST_STATE`) с учётом отказоустойчивости (reconnect после `runtime.lastError`).
  - [ ] Добавить fail-safe таймер сканирования DOM (heartbeat) и экспортировать формат heartbeat в `shared/contracts`.
  - [ ] Логировать ключевые события (инициализация, heartbeat, ошибки отправки) и проверить работу verbose-флага в chrome.storage.session.

## Фаза 3. Background service worker ⏳

- [ ] **Фреймворк service worker**
  - [ ] Создать точку входа `src/background/index.ts` с регистрацией всех listeners (`runtime`, `tabs`, `alarms`, `storage`).
  - [ ] Настроить маршрутизацию сообщений через единый диспетчер (`handleMessage`), покрыть unit-тестами happy path + ошибки `runtime.lastError`.
- [ ] **Агрегатор состояния и надёжность хранения**
  - [ ] Реализовать `aggregator.ts` для обработки `TASKS_UPDATE`, поддержки нескольких вкладок и обновления `chrome.storage.session` по схеме `codex.tasks/state/session.json`.
  - [ ] Добавить retry-механику записи состояния: при ошибке `chrome.runtime.lastError` повторять через ~1 c максимум 3 попытки, логировать неудачи.
  - [ ] Синхронизировать heartbeat и `lastSeen` для вкладок; сбрасывать state при закрытии вкладки, покрыть unit-тестами сценарии рестарта service worker.
- [ ] **Уведомления, i18n и логирование**
  - [ ] В `notifications.ts` реализовать антидребезг уведомлений, использовать локализованные строки (RU/EN) через общий i18n-слой.
  - [ ] Инкапсулировать единичное уведомление при переходе `totalActiveCount` >0 → 0 и сценарий очистки при новых задачах.
  - [ ] Интегрировать verbose-логирование: чтение флага из `chrome.storage.session`, переключение уровня и unit-тесты на адаптер.
- [ ] **Алгоритм будильников и внешние эффекты**
  - [ ] Реализовать `alarms.ts` с расписанием `chrome.alarms`, поддержкой повторных `PING` и восстановлением после sleep.
  - [ ] Управлять `autoDiscardableOff` для вкладок Codex и документировать side-effects.
  - [ ] Подготовить контрактные тесты на взаимодействие alarm → message → обновление state.

## Фаза 4. Popup UI ⏳

- [ ] **Интеграция со state**
  - [ ] Создать адаптер, запрашивающий агрегированное состояние у background (`chrome.runtime.sendMessage`).
  - [ ] Реализовать отображение списка вкладок/сигналов и fallback «Нет активных задач».
- [ ] **UX и локализация**
  - [ ] Добавить базовый стиль (CSS/HTMX шаблоны), обеспечить поддержку RU/EN текстов.
  - [ ] Покрыть рендер unit-тестами (jsdom/snapshots) и проверить устойчивость к пустым/большим спискам.

## Фаза 5. Тестирование и качество ⏳

- [ ] **Unit tests**
  - [ ] Подготовить общие моки Chrome API и time-helpers для повторного использования в разных пакетах.
  - [ ] Покрыть детекторы (D1/D2 + заглушка D3), агрегатор, уведомления, storage helper'ы и verbose-логирование (`vitest`).
  - [ ] Добавить negative-cases: ошибки записи `storage.session`, неверные сообщения, потеря heartbeat.
- [ ] **Contract tests**
  - [ ] Реализовать проверку DTO/state JSON Schema (`ajv`/`schemathesis`) в CI-скрипте.
  - [ ] Валидировать OpenAPI (`contracts/openapi.yaml`) против background/popup-хендлеров и задокументировать команды запуска.
- [ ] **Локальный HTTP-адаптер для тестов**
  - [ ] Реализовать `msw` (или аналогичный) адаптер, эмулирующий `/background/tasks-update`, `/background/state`, `/popup/state`.
  - [ ] Подключить контрактные проверки по `contracts/openapi.yaml`, DTO/State/Settings согласно требованиям `spec/test-plan.md`.
- [ ] **Integration tests**
  - [ ] Смоделировать ключевые use-cases (UC-1..UC-3) с фейковым DOM, обменом сообщениями и будильниками.
  - [ ] Проверить устойчивость к перезапуску service worker, закрытию вкладок и переключению verbose-флага.

## Фаза 6. Документация, упаковка и QA ⏳

- [ ] **Документация**
  - [ ] Обновить `README.md` инструкциями по сборке (`npm install`, `npm run build`, установка unpacked расширения).
  - [ ] Зафиксировать Known Issues и TODO для релиза v0.2.0 (настройки, бейдж, звук).
- [ ] **Сборка и ручное тестирование**
  - [ ] Подготовить production build и проверить в Chrome (режим разработчика).
  - [ ] Провести смоук-тесты: одиночная вкладка, несколько вкладок, сон service worker.
- [ ] **Готовность к релизу**
  - [ ] Собрать пакет для Chrome Web Store (zip), убедиться в соответствии требованиям (раздел «Критерии готовности» в `spec/implementation-plan.md`).
  - [ ] Сформировать CHANGELOG и план следующих итераций (v0.2.0).
