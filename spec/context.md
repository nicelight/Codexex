# Codex Tasks Watcher — Context Summary

## Purpose of the Artifact
Этот документ фиксирует результаты первичного анализа брифа `docs/brief.md` и существующих материалов. Цель — убедиться в корректном понимании продукта перед переходом к детализации стейкхолдеров и границ.

## Problem Statement
- Пользователь запускает длительные задачи в Codex и вынужден вручную проверять статус каждой вкладки.
- Нет официального API для отслеживания прогресса; требуется DOM-наблюдение.
- Нужен единый сигнал, когда **во всех** открытых вкладках нет активных задач.

## Target Solution (высокоуровнево)
- Расширение Chrome (Manifest V3) с минимальными правами (`storage`, `notifications`, `alarms`, `scripting`, `tabs`, узкие `host_permissions`).
- Content script собирает сигналы из DOM (спиннеры, кнопки Stop, эвристики карточек) и отправляет состояние фоновой службе.
- Background service worker агрегирует состояния вкладок, применяет антидребезг, управляет уведомлениями и политикой autoDiscardable.
- Popup отображает список активных задач или подтверждает их отсутствие.

## Key Functional Requirements
1. Поддержка нескольких вкладок Codex: уведомление только при полном отсутствии активных задач.
2. Надёжные детекторы прогресса (минимум D1, D2; D3 — резерв для v0.2.0+, где при активации участвует в общем подсчёте задач).
3. Антидребезг уведомления (12–15 секунд) для фильтрации кратких всплесков активности.
4. Фоновый пинг вкладок (через `chrome.alarms`) для восстановления состояния после сна сервис-воркера.
5. Отсутствие внешних сетевых взаимодействий, хранение состояния в `chrome.storage.session`.

## Non-Functional Expectations
- Ограничение нагрузки: не более одного сканирования DOM в секунду; фоновые процессы <2% CPU на вкладку в простое.
- Работоспособность при неактивных вкладках и после сна service worker.
- Интернациональность UI (RU/EN) и устойчивость к лёгкому редизайну DOM.
- Быстрое применение `autoDiscardableOff` для вкладок Codex (несколько секунд после изменения).

## Constraints & Assumptions
- Доступные сигнатуры DOM могут меняться; архитектура должна предусматривать быструю замену детекторов.
- Пользователь обязан быть авторизован и иметь хотя бы одну открытую вкладку Codex; офлайн-режим не рассматривается.
- MVP (v0.1.0) без пользовательских настроек и звукового сигнала; расширение функционала ожидается в v0.2.0+.

## Known Gaps / Questions
- Требуются уточнения по приоритетам звуковых/бейдж уведомлений для будущих версий.
- Не описаны требования к UX popup (структура списка задач, сортировка, локализация текста).
- Нужно уточнить, допускается ли ручное обновление DOM-детекторов без публикации новой версии (через конфиги) или нужен релиз.

## Next Steps
- Определить стейкхолдеров и границы системы (этап 2 роадмапа).
- Подготовить словарь доменных терминов для унификации (этап 3).
- Начать сбор вопросов для уточнения NFR и UX в последующих артефактах.

## Stakeholders & Scope

### Stakeholders

- **Конечный пользователь (разработчик Codex):** запускает длительные задачи, рассчитывает на единое уведомление по окончании всех задач.
- **Команда расширения (мы):** отвечает за проектирование спецификаций, соблюдение политик приватности и релизов Chrome Web Store.
- **Платформа Codex (OpenAI):** источник DOM и поведения задач; косвенный стейкхолдер, от изменений UI зависит устойчивость детекторов.
- **Chrome Runtime (Manifest V3):** накладывает ограничения на жизненный цикл сервис-воркера, права доступа и хранение данных.

### In-scope

- Контент-скрипт, работающий на доменах `https://*.openai.com/*`, собирает сигналы активности задач.
- Фоновый сервис-воркер агрегирует состояния вкладок, применяет антидребезг и управляет уведомлениями/autoDiscardable.
- Popup интерфейс отображает агрегированное состояние и позволяет быстро перейти к вкладке.
- Хранение состояния только локально (`chrome.storage.session`) и управление минимальным набором прав.

### Out-of-scope / External Dependencies

- Изменение или расширение Codex API; взаимодействие ограничено чтением DOM и необязательным мониторингом `fetch`.
- Пользовательские настройки, звуковые уведомления и бейджи — отложены до версии v0.2.0+.
- Любые серверные компоненты или синхронизация данных между устройствами.
