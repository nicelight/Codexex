{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://codex.tasks/contracts/state/aggregated-state.schema.json",
  "title": "AggregatedTabsState",
  "type": "object",
  "description": "Состояние, которое хранит background service worker в chrome.storage.session",
  "required": ["tabs", "lastTotal", "debounce"],
  "properties": {
    "tabs": {
      "type": "object",
      "description": "Словарь состояний вкладок по идентификатору tabId",
      "additionalProperties": {
        "$ref": "#/definitions/tabState"
      }
    },
    "lastTotal": {
      "type": "integer",
      "minimum": 0,
      "description": "Суммарное количество активных задач по всем вкладкам главного списка Codex (отдельно суммируется максимум для вкладок tab=all и tab=code_reviews)"
    },
    "debounce": {
      "$ref": "#/definitions/debounceState"
    }
  },
  "definitions": {
    "tabState": {
      "type": "object",
      "required": ["origin", "title", "count", "active", "updatedAt", "lastSeenAt", "heartbeat"],
      "additionalProperties": false,
      "properties": {
        "origin": {
          "type": "string",
          "format": "uri",
          "description": "URL вкладки Codex (https://chatgpt.com/codex или с параметром tab=all|code_reviews)"
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "description": "Отображаемое название вкладки"
        },
        "count": {
          "type": "integer",
          "minimum": 0,
          "description": "Количество активных задач, присоединённых к вкладке"
        },
        "active": {
          "type": "boolean",
          "description": "Признак наличия активности по мнению контент-скрипта"
        },
        "updatedAt": {
          "type": "number",
          "description": "Unix timestamp (мс) последнего обновления состояния вкладки"
        },
        "lastSeenAt": {
          "type": "number",
          "description": "Unix timestamp (мс) последнего полученного сообщения (`TASKS_UPDATE` или `TASKS_HEARTBEAT`)"
        },
        "heartbeat": {
          "$ref": "#/definitions/heartbeatState"
        },
        "signals": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/tabSignal"
          }
        }
      }
    },
    "tabSignal": {
      "allOf": [
        {
          "$ref": "../dto/content-update.schema.json#/definitions/signal"
        }
      ]
    },
    "heartbeatState": {
      "type": "object",
      "required": ["lastReceivedAt", "expectedIntervalMs", "status", "missedCount"],
      "additionalProperties": false,
      "properties": {
        "lastReceivedAt": {
          "type": "number",
          "minimum": 0,
          "description": "Unix timestamp (мс) последнего heartbeat"
        },
        "expectedIntervalMs": {
          "type": "integer",
          "minimum": 1000,
          "maximum": 60000,
          "description": "Ожидаемый интервал между heartbeat (мс)"
        },
        "status": {
          "type": "string",
          "enum": ["OK", "STALE"],
          "description": "Текущий статус heartbeat для вкладки"
        },
        "missedCount": {
          "type": "integer",
          "minimum": 0,
          "description": "Сколько раз подряд ожидание heartbeat было нарушено"
        }
      }
    },
    "debounceState": {
      "type": "object",
      "required": ["ms", "since"],
      "additionalProperties": false,
      "properties": {
        "ms": {
          "type": "integer",
          "minimum": 0,
          "maximum": 60000,
          "default": 12000,
          "description": "Длительность окна антидребезга в миллисекундах"
        },
        "since": {
          "type": "number",
          "minimum": 0,
          "description": "Unix timestamp (мс) начала окна антидребезга; 0, если окно неактивно"
        }
      }
    }
  },
  "additionalProperties": false
}
